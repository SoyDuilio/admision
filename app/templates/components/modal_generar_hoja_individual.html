<!-- 
    Modal de Generaci√≥n Individual
    app/templates/components/modal_generar_individual.html
    
    FUNCIONALIDADES:
    - Buscar postulante por DNI o C√≥digo de Hoja
    - Mostrar informaci√≥n si ya tiene hoja asignada
    - Formulario de reimpresi√≥n con motivo y validaciones
    - Generar PDF individual
-->

<div id="modalGenerarIndividual" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 700px;">
        
        <!-- Header -->
        <div class="modal-header">
            <h2>üìÑ Generar Hoja Individual</h2>
            <button class="modal-close" onclick="cerrarModalIndividual()">‚úï</button>
        </div>

        <div class="modal-body">
            
            <!-- ============================================ -->
            <!-- PASO 1: B√öSQUEDA -->
            <!-- ============================================ -->
            <div id="busquedaContainer" style="display: block;">
                <div class="busqueda-section">
                    <h3 style="margin-bottom: 16px;">üîç Buscar Postulante</h3>
                    
                    <!-- Tipo de b√∫squeda -->
                    <div class="search-type-selector">
                        <label class="radio-option">
                            <input type="radio" name="tipoBusqueda" value="dni" checked onchange="cambiarTipoBusqueda()">
                            <span>Por DNI</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="tipoBusqueda" value="codigo" onchange="cambiarTipoBusqueda()">
                            <span>Por C√≥digo de Hoja</span>
                        </label>
                    </div>

                    <!-- Input de b√∫squeda -->
                    <div class="search-input-group">
                        <input type="text" 
                               id="inputBusqueda" 
                               class="search-input-large" 
                               placeholder="Ingrese DNI del postulante..."
                               maxlength="8">
                        <button class="btn-search" onclick="buscarPostulante()">
                            üîç Buscar
                        </button>
                    </div>
                </div>

                <!-- Loading -->
                <div id="loadingBusqueda" style="display: none; text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p style="color: #94a3b8; margin-top: 16px;">Buscando...</p>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- RESULTADO: POSTULANTE SIN HOJA -->
            <!-- ============================================ -->
            <div id="sinHojaContainer" style="display: none;">
                <div class="alert-warning">
                    <div style="font-size: 2rem; margin-bottom: 12px;">‚ö†Ô∏è</div>
                    <h3>Postulante sin hoja asignada</h3>
                    <div id="datosPostulanteSinHoja" style="margin: 16px 0;"></div>
                    <p style="margin-top: 16px; color: #94a3b8; font-size: 0.9rem;">
                        Este postulante debe ser asignado a un aula primero.<br>
                        Use la opci√≥n "Generar por Aula" para asignar y generar hojas masivamente.
                    </p>
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="volverABusqueda()">
                        ‚Üê Nueva B√∫squeda
                    </button>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- RESULTADO: POSTULANTE CON HOJA (REIMPRESI√ìN) -->
            <!-- ============================================ -->
            <div id="conHojaContainer" style="display: none;">
                
                <!-- Informaci√≥n del postulante -->
                <div class="postulante-info-card">
                    <h3 style="margin-bottom: 16px;">‚úÖ Postulante Encontrado</h3>
                    <div id="datosPostulanteConHoja"></div>
                </div>

                <!-- Alerta de hoja existente -->
                <div class="alert-info">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 1.5rem;">üìã</span>
                        <strong>Ya tiene hoja asignada</strong>
                    </div>
                    <div id="datosHojaExistente"></div>
                </div>

                <!-- Formulario de reimpresi√≥n -->
                <div class="reimpresion-form">
                    <h3 style="margin-bottom: 16px; color: #f59e0b;">‚ö†Ô∏è Formulario de Reimpresi√≥n</h3>
                    
                    <div class="form-group">
                        <label>Motivo de reimpresi√≥n *</label>
                        <select id="motivoReimpresion" class="form-select">
                            <option value="">Seleccionar motivo...</option>
                            <option value="deterioro">Hoja deteriorada</option>
                            <option value="extravio">Hoja extraviada</option>
                            <option value="error_marcacion">Error en marcaci√≥n</option>
                            <option value="ilegible">C√≥digo ilegible</option>
                            <option value="otro">Otro motivo</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>¬øSe devolvi√≥ la hoja original? *</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="hojaDevuelta" value="true">
                                <span>S√≠, se devolvi√≥</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="hojaDevuelta" value="false">
                                <span>No se devolvi√≥</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Solicitado por *</label>
                        <input type="text" 
                               id="solicitadoPor" 
                               class="form-input" 
                               placeholder="Nombre completo de quien solicita">
                    </div>

                    <div class="form-group">
                        <label>Observaciones (opcional)</label>
                        <textarea id="observaciones" 
                                  class="form-textarea" 
                                  rows="3"
                                  placeholder="Detalles adicionales..."></textarea>
                    </div>
                </div>

                <!-- Botones -->
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="volverABusqueda()">
                        ‚Üê Nueva B√∫squeda
                    </button>
                    <button class="btn-primary btn-warning" onclick="confirmarReimpresion()">
                        ‚úì Reimprimir Hoja
                    </button>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- PROCESANDO -->
            <!-- ============================================ -->
            <div id="procesandoContainer" style="display: none; text-align: center; padding: 60px 20px;">
                <div class="spinner-large"></div>
                <h3 style="margin-top: 20px; color: white;">Generando hoja...</h3>
                <p style="color: #94a3b8; margin-top: 10px;">Por favor espere...</p>
            </div>

        </div>
    </div>
</div>

<style>
/* B√∫squeda */
.busqueda-section {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 24px;
}

.search-type-selector {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
}

.radio-option {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.radio-option:hover {
    background: rgba(255, 255, 255, 0.08);
}

.radio-option input[type="radio"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.radio-option input[type="radio"]:checked + span {
    color: #60a5fa;
    font-weight: 600;
}

.radio-option span {
    color: #94a3b8;
    font-size: 0.95rem;
}

.search-input-group {
    display: flex;
    gap: 12px;
}

.search-input-large {
    flex: 1;
    padding: 14px 18px;
    background: rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(59, 130, 246, 0.3);
    border-radius: 8px;
    color: white;
    font-size: 1.1rem;
    font-weight: 600;
}

.search-input-large:focus {
    outline: none;
    border-color: #3b82f6;
}

.btn-search {
    padding: 14px 32px;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
}

.btn-search:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    transform: translateY(-2px);
}

/* Alertas */
.alert-warning {
    background: rgba(245, 158, 11, 0.1);
    border: 2px solid rgba(245, 158, 11, 0.3);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    margin-bottom: 20px;
}

.alert-warning h3 {
    color: #fbbf24;
    margin-bottom: 12px;
}

.alert-info {
    background: rgba(59, 130, 246, 0.1);
    border: 2px solid rgba(59, 130, 246, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

/* Card de informaci√≥n */
.postulante-info-card {
    background: rgba(16, 185, 129, 0.1);
    border: 2px solid rgba(16, 185, 129, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    color: #94a3b8;
    font-size: 0.875rem;
}

.info-value {
    color: white;
    font-weight: 600;
}

/* Formulario */
.reimpresion-form {
    background: rgba(245, 158, 11, 0.05);
    border: 2px solid rgba(245, 158, 11, 0.2);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    color: #e5e7eb;
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 8px;
}

.form-select,
.form-input,
.form-textarea {
    width: 100%;
    padding: 12px 16px;
    background: rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    font-size: 0.95rem;
}

.form-select:focus,
.form-input:focus,
.form-textarea:focus {
    outline: none;
    border-color: #f59e0b;
}

.form-select option {
    background: #1e293b;
    color: white;
}

.radio-group {
    display: flex;
    gap: 16px;
}

/* Spinner */
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(59, 130, 246, 0.2);
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

.btn-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706) !important;
}

.btn-warning:hover {
    background: linear-gradient(135deg, #d97706, #b45309) !important;
}
</style>

<script>
// ============================================================================
// VARIABLES GLOBALES
// ============================================================================

let postulanteEncontrado = null;
let hojaExistente = null;

// ============================================================================
// ABRIR/CERRAR MODAL
// ============================================================================

function abrirModalHojaIndividual() {
    document.getElementById('modalGenerarIndividual').style.display = 'flex';
    volverABusqueda();
}

function cerrarModalIndividual() {
    document.getElementById('modalGenerarIndividual').style.display = 'none';
    limpiarFormulario();
}

function volverABusqueda() {
    // Mostrar b√∫squeda
    document.getElementById('busquedaContainer').style.display = 'block';
    document.getElementById('sinHojaContainer').style.display = 'none';
    document.getElementById('conHojaContainer').style.display = 'none';
    document.getElementById('procesandoContainer').style.display = 'none';
    document.getElementById('loadingBusqueda').style.display = 'none';
    
    // Limpiar
    document.getElementById('inputBusqueda').value = '';
    limpiarFormulario();
}

function limpiarFormulario() {
    document.getElementById('motivoReimpresion').value = '';
    document.getElementById('solicitadoPor').value = '';
    document.getElementById('observaciones').value = '';
    
    const radios = document.getElementsByName('hojaDevuelta');
    radios.forEach(r => r.checked = false);
    
    postulanteEncontrado = null;
    hojaExistente = null;
}

// ============================================================================
// CAMBIAR TIPO DE B√öSQUEDA
// ============================================================================

function cambiarTipoBusqueda() {
    const tipo = document.querySelector('input[name="tipoBusqueda"]:checked').value;
    const input = document.getElementById('inputBusqueda');
    
    if (tipo === 'dni') {
        input.placeholder = 'Ingrese DNI del postulante...';
        input.maxLength = 8;
    } else {
        input.placeholder = 'Ingrese c√≥digo de hoja...';
        input.maxLength = 20;
    }
    
    input.value = '';
    input.focus();
}

// ============================================================================
// BUSCAR POSTULANTE
// ============================================================================

async function buscarPostulante() {
    const tipo = document.querySelector('input[name="tipoBusqueda"]:checked').value;
    const valor = document.getElementById('inputBusqueda').value.trim();
    
    if (!valor) {
        alert('Debe ingresar un valor de b√∫squeda');
        return;
    }
    
    // Mostrar loading
    document.getElementById('loadingBusqueda').style.display = 'block';
    
    try {
        const response = await fetch('/api/buscar-postulante-para-hoja', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tipo_busqueda: tipo,
                valor: valor,
                proceso_admision: '2025-2'
            })
        });
        
        const data = await response.json();
        
        document.getElementById('loadingBusqueda').style.display = 'none';
        
        if (!data.success) {
            alert(data.message || 'No se encontr√≥ el postulante');
            return;
        }
        
        postulanteEncontrado = data.postulante;
        hojaExistente = data.hoja_existente;
        
        if (hojaExistente) {
            mostrarFormularioReimpresion();
        } else {
            mostrarPostulanteSinHoja();
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error al buscar postulante');
        document.getElementById('loadingBusqueda').style.display = 'none';
    }
}

// ============================================================================
// MOSTRAR RESULTADOS
// ============================================================================

function mostrarPostulanteSinHoja() {
    document.getElementById('busquedaContainer').style.display = 'none';
    document.getElementById('sinHojaContainer').style.display = 'block';
    
    const html = `
        <div class="info-row">
            <span class="info-label">DNI:</span>
            <span class="info-value">${postulanteEncontrado.dni}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Nombre:</span>
            <span class="info-value">${postulanteEncontrado.nombre_completo}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Programa:</span>
            <span class="info-value">${postulanteEncontrado.programa || 'N/A'}</span>
        </div>
    `;
    
    document.getElementById('datosPostulanteSinHoja').innerHTML = html;
}

function mostrarFormularioReimpresion() {
    document.getElementById('busquedaContainer').style.display = 'none';
    document.getElementById('conHojaContainer').style.display = 'block';
    
    // Datos del postulante
    let htmlPostulante = `
        <div class="info-row">
            <span class="info-label">DNI:</span>
            <span class="info-value">${postulanteEncontrado.dni}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Nombre:</span>
            <span class="info-value">${postulanteEncontrado.nombre_completo}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Programa:</span>
            <span class="info-value">${postulanteEncontrado.programa || 'N/A'}</span>
        </div>
    `;
    
    document.getElementById('datosPostulanteConHoja').innerHTML = htmlPostulante;
    
    // Datos de hoja existente
    let htmlHoja = `
        <div class="info-row">
            <span class="info-label">C√≥digo de Hoja:</span>
            <span class="info-value" style="color: #60a5fa; font-size: 1.2rem;">${hojaExistente.codigo_hoja}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Aula:</span>
            <span class="info-value">${hojaExistente.codigo_aula}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Profesor:</span>
            <span class="info-value">${hojaExistente.dni_profesor}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Generada:</span>
            <span class="info-value">${new Date(hojaExistente.created_at).toLocaleString()}</span>
        </div>
    `;
    
    document.getElementById('datosHojaExistente').innerHTML = htmlHoja;
}

// ============================================================================
// CONFIRMAR REIMPRESI√ìN
// ============================================================================

async function confirmarReimpresion() {
    // Validar formulario
    const motivo = document.getElementById('motivoReimpresion').value;
    const hojaDevuelta = document.querySelector('input[name="hojaDevuelta"]:checked');
    const solicitadoPor = document.getElementById('solicitadoPor').value.trim();
    const observaciones = document.getElementById('observaciones').value.trim();
    
    if (!motivo) {
        alert('Debe seleccionar un motivo de reimpresi√≥n');
        return;
    }
    
    if (!hojaDevuelta) {
        alert('Debe indicar si se devolvi√≥ la hoja original');
        return;
    }
    
    if (!solicitadoPor) {
        alert('Debe indicar qui√©n solicita la reimpresi√≥n');
        return;
    }
    
    // Confirmar
    if (!confirm(
        `¬øConfirmar reimpresi√≥n?\n\n` +
        `C√≥digo anterior: ${hojaExistente.codigo_hoja}\n` +
        `Este c√≥digo ser√° anulado y se generar√° uno nuevo.\n\n` +
        `¬øContinuar?`
    )) {
        return;
    }
    
    // Mostrar loading
    document.getElementById('conHojaContainer').style.display = 'none';
    document.getElementById('procesandoContainer').style.display = 'block';
    
    try {
        const response = await fetch('/api/reimprimir-hoja', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                postulante_id: postulanteEncontrado.id,
                hoja_anterior_id: hojaExistente.id,
                motivo: motivo,
                hoja_original_devuelta: hojaDevuelta.value === 'true',
                solicitado_por: solicitadoPor,
                observaciones: observaciones,
                proceso_admision: '2025-2'
            })
        });
        
        if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
        }
        
        // Descargar PDF
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `hoja_reimpresa_${postulanteEncontrado.dni}_${Date.now()}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        
        alert('‚úÖ Hoja reimpresa exitosamente\n\nSe ha descargado el PDF.');
        
        cerrarModalIndividual();
        
        // Recargar si existe funci√≥n
        if (typeof verificarAsignaciones === 'function') {
            await verificarAsignaciones();
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al reimprimir hoja:\n\n' + error.message);
        volverABusqueda();
    }
}
</script>