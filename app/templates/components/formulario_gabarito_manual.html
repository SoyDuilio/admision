<!-- 
    COMPONENTE: Formulario Manual de Gabarito
    app/templates/components/formulario_gabarito_manual.html
    
    Formulario mejorado para ingreso manual de respuestas correctas.
    Formato: A => [preguntas], B => [preguntas], etc.
-->

<div id="formulario-gabarito-manual" class="formulario-container">
    
    <!-- Header con instrucciones -->
    <div class="instrucciones-formulario">
        <h3>üìù Ingreso Manual de Respuestas Correctas</h3>
        <p>
            Ingrese los <strong>n√∫meros de pregunta</strong> para cada respuesta correcta.
            Puede usar comas, espacios o saltos de l√≠nea para separar los n√∫meros.
        </p>
        <p class="ejemplo">
            <strong>Ejemplo:</strong> Para la letra A: <code>3, 5, 7, 12, 15, 18...</code>
        </p>
    </div>

    <!-- Formulario por letras -->
    <div class="letras-grid">
        
        <!-- Letra A -->
        <div class="letra-box">
            <div class="letra-header">
                <span class="letra-label">A</span>
                <span class="contador" id="contador-A">0 preguntas</span>
            </div>
            <textarea 
                id="input-A" 
                class="input-preguntas" 
                placeholder="Ej: 3, 5, 7, 12, 15, 18, 21..."
                rows="4"
                oninput="validarInput('A')"
            ></textarea>
            <div class="feedback" id="feedback-A"></div>
        </div>

        <!-- Letra B -->
        <div class="letra-box">
            <div class="letra-header">
                <span class="letra-label">B</span>
                <span class="contador" id="contador-B">0 preguntas</span>
            </div>
            <textarea 
                id="input-B" 
                class="input-preguntas" 
                placeholder="Ej: 2, 4, 6, 9, 11, 14..."
                rows="4"
                oninput="validarInput('B')"
            ></textarea>
            <div class="feedback" id="feedback-B"></div>
        </div>

        <!-- Letra C -->
        <div class="letra-box">
            <div class="letra-header">
                <span class="letra-label">C</span>
                <span class="contador" id="contador-C">0 preguntas</span>
            </div>
            <textarea 
                id="input-C" 
                class="input-preguntas" 
                placeholder="Ej: 1, 8, 10, 13, 17..."
                rows="4"
                oninput="validarInput('C')"
            ></textarea>
            <div class="feedback" id="feedback-C"></div>
        </div>

        <!-- Letra D -->
        <div class="letra-box">
            <div class="letra-header">
                <span class="letra-label">D</span>
                <span class="contador" id="contador-D">0 preguntas</span>
            </div>
            <textarea 
                id="input-D" 
                class="input-preguntas" 
                placeholder="Ej: 33, 42, 45, 49..."
                rows="4"
                oninput="validarInput('D')"
            ></textarea>
            <div class="feedback" id="feedback-D"></div>
        </div>

        <!-- Letra E -->
        <div class="letra-box">
            <div class="letra-header">
                <span class="letra-label">E</span>
                <span class="contador" id="contador-E">0 preguntas</span>
            </div>
            <textarea 
                id="input-E" 
                class="input-preguntas" 
                placeholder="Ej: 81, 82, 83, 84..."
                rows="4"
                oninput="validarInput('E')"
            ></textarea>
            <div class="feedback" id="feedback-E"></div>
        </div>

    </div>

    <!-- Resumen en tiempo real -->
    <div class="resumen-validacion">
        <h4>üìä Resumen de Validaci√≥n</h4>
        <div class="resumen-grid">
            <div class="resumen-item">
                <span>A:</span>
                <span id="total-A" class="total-numero">0</span>
            </div>
            <div class="resumen-item">
                <span>B:</span>
                <span id="total-B" class="total-numero">0</span>
            </div>
            <div class="resumen-item">
                <span>C:</span>
                <span id="total-C" class="total-numero">0</span>
            </div>
            <div class="resumen-item">
                <span>D:</span>
                <span id="total-D" class="total-numero">0</span>
            </div>
            <div class="resumen-item">
                <span>E:</span>
                <span id="total-E" class="total-numero">0</span>
            </div>
        </div>
        
        <div class="total-general" id="total-general">
            TOTAL: <span id="total-general-numero">0</span> / 100
        </div>
        
        <div id="mensajes-validacion"></div>
    </div>

    <!-- Bot√≥n de guardar -->
    <button 
        type="button" 
        class="btn-guardar-gabarito" 
        id="btn-guardar-manual"
        onclick="guardarGabaritoManual()"
        disabled
    >
        üíæ Guardar y Continuar
    </button>

</div>

<style>
    .formulario-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .instrucciones-formulario {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-left: 4px solid #1976d2;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }

    .instrucciones-formulario h3 {
        color: #1976d2;
        margin-bottom: 10px;
    }

    .instrucciones-formulario p {
        margin: 8px 0;
        color: #333;
    }

    .instrucciones-formulario .ejemplo {
        background: rgba(255, 255, 255, 0.7);
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
    }

    .instrucciones-formulario code {
        background: #fff;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        color: #d32f2f;
    }

    .letras-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .letra-box {
        background: white;
        border: 2px solid #ddd;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s;
    }

    .letra-box:hover {
        border-color: #1976d2;
        box-shadow: 0 4px 12px rgba(25, 118, 210, 0.1);
    }

    .letra-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .letra-label {
        font-size: 24px;
        font-weight: bold;
        color: #1976d2;
        background: #e3f2fd;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .contador {
        font-size: 14px;
        color: #666;
        font-weight: 600;
    }

    .input-preguntas {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        resize: vertical;
        transition: all 0.3s;
    }

    .input-preguntas:focus {
        outline: none;
        border-color: #1976d2;
        box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
    }

    .input-preguntas.valido {
        border-color: #4caf50;
    }

    .input-preguntas.error {
        border-color: #f44336;
    }

    .feedback {
        margin-top: 8px;
        font-size: 12px;
        min-height: 20px;
    }

    .feedback.exito {
        color: #4caf50;
    }

    .feedback.error {
        color: #f44336;
    }

    .resumen-validacion {
        background: #f5f5f5;
        border: 2px solid #ddd;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 30px;
    }

    .resumen-validacion h4 {
        margin-bottom: 16px;
        color: #333;
    }

    .resumen-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }

    .resumen-item {
        background: white;
        padding: 12px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
    }

    .total-numero {
        color: #1976d2;
        font-size: 18px;
    }

    .total-general {
        background: linear-gradient(135deg, #1976d2, #1565c0);
        color: white;
        padding: 16px;
        border-radius: 8px;
        text-align: center;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 16px;
    }

    .total-general.completo {
        background: linear-gradient(135deg, #4caf50, #388e3c);
    }

    .total-general.error {
        background: linear-gradient(135deg, #f44336, #d32f2f);
    }

    #mensajes-validacion {
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
    }

    #mensajes-validacion.oculto {
        display: none;
    }

    #mensajes-validacion.warning {
        background: #fff3cd;
        border: 1px solid #ffc107;
        color: #856404;
    }

    #mensajes-validacion.error {
        background: #f8d7da;
        border: 1px solid #f44336;
        color: #721c24;
    }

    #mensajes-validacion.success {
        background: #d4edda;
        border: 1px solid #4caf50;
        color: #155724;
    }

    .btn-guardar-gabarito {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #4caf50, #388e3c);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-guardar-gabarito:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(76, 175, 80, 0.3);
    }

    .btn-guardar-gabarito:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    @media (max-width: 768px) {
        .resumen-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
// Estado global del formulario
let estadoGabarito = {
    A: [],
    B: [],
    C: [],
    D: [],
    E: []
};

let todasLasPreguntas = new Set();

function validarInput(letra) {
    const input = document.getElementById(`input-${letra}`);
    const texto = input.value.trim();
    
    // Extraer n√∫meros del texto (separados por coma, espacio, salto de l√≠nea, etc)
    const numeros = texto
        .split(/[\s,;]+/)
        .filter(n => n !== '')
        .map(n => parseInt(n))
        .filter(n => !isNaN(n) && n >= 1 && n <= 100);
    
    // Actualizar estado
    estadoGabarito[letra] = numeros;
    
    // Actualizar contador
    document.getElementById(`contador-${letra}`).textContent = `${numeros.length} preguntas`;
    document.getElementById(`total-${letra}`).textContent = numeros.length;
    
    // Feedback
    const feedback = document.getElementById(`feedback-${letra}`);
    
    if (numeros.length === 0 && texto !== '') {
        input.classList.add('error');
        input.classList.remove('valido');
        feedback.textContent = '‚ö†Ô∏è No se detectaron n√∫meros v√°lidos';
        feedback.className = 'feedback error';
    } else if (numeros.length > 0) {
        input.classList.add('valido');
        input.classList.remove('error');
        feedback.textContent = `‚úì ${numeros.length} n√∫meros v√°lidos detectados`;
        feedback.className = 'feedback exito';
    } else {
        input.classList.remove('error', 'valido');
        feedback.textContent = '';
        feedback.className = 'feedback';
    }
    
    // Validar globalmente
    validarGlobal();
}

function validarGlobal() {
    // Recolectar todas las preguntas
    todasLasPreguntas = new Set();
    let duplicados = [];
    
    for (let letra of ['A', 'B', 'C', 'D', 'E']) {
        for (let num of estadoGabarito[letra]) {
            if (todasLasPreguntas.has(num)) {
                duplicados.push(num);
            }
            todasLasPreguntas.add(num);
        }
    }
    
    const total = todasLasPreguntas.size;
    const totalConDuplicados = Object.values(estadoGabarito).reduce((sum, arr) => sum + arr.length, 0);
    
    // Actualizar total
    document.getElementById('total-general-numero').textContent = total;
    
    const totalElement = document.getElementById('total-general');
    const mensajesElement = document.getElementById('mensajes-validacion');
    const btnGuardar = document.getElementById('btn-guardar-manual');
    
    // Determinar estado
    if (total === 0) {
        totalElement.className = 'total-general';
        mensajesElement.className = 'oculto';
        btnGuardar.disabled = true;
        return;
    }
    
    let mensajes = [];
    let tipoMensaje = 'warning';
    let esValido = false;
    
    // Validar duplicados
    if (duplicados.length > 0) {
        mensajes.push(`‚ùå Preguntas duplicadas: ${[...new Set(duplicados)].sort((a,b) => a-b).join(', ')}`);
        tipoMensaje = 'error';
    }
    
    // Validar total
    if (total < 100) {
        const faltantes = 100 - total;
        mensajes.push(`‚ö†Ô∏è Faltan ${faltantes} preguntas`);
        
        // Mostrar qu√© preguntas faltan
        const preguntasFaltantes = [];
        for (let i = 1; i <= 100; i++) {
            if (!todasLasPreguntas.has(i)) {
                preguntasFaltantes.push(i);
            }
        }
        if (preguntasFaltantes.length <= 10) {
            mensajes.push(`Preguntas faltantes: ${preguntasFaltantes.join(', ')}`);
        }
    } else if (total > 100) {
        mensajes.push(`‚ùå Hay ${total - 100} preguntas de m√°s`);
        tipoMensaje = 'error';
    } else if (total === 100 && duplicados.length === 0) {
        mensajes.push(`‚úÖ ¬°Perfecto! Todas las 100 preguntas est√°n completas y sin duplicados.`);
        tipoMensaje = 'success';
        esValido = true;
    }
    
    // Actualizar UI
    if (total === 100 && duplicados.length === 0) {
        totalElement.className = 'total-general completo';
    } else if (tipoMensaje === 'error') {
        totalElement.className = 'total-general error';
    } else {
        totalElement.className = 'total-general';
    }
    
    mensajesElement.className = tipoMensaje;
    mensajesElement.innerHTML = mensajes.map(m => `<div>${m}</div>`).join('');
    
    // Habilitar/deshabilitar bot√≥n
    btnGuardar.disabled = !esValido;
}

async function guardarGabaritoManual() {
    // Convertir a formato esperado por el backend
    const respuestas = {};
    
    for (let i = 1; i <= 100; i++) {
        for (let letra of ['A', 'B', 'C', 'D', 'E']) {
            if (estadoGabarito[letra].includes(i)) {
                respuestas[i.toString()] = letra;
                break;
            }
        }
    }
    
    try {
        const response = await fetch('/api/gabarito/procesar-manual', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                respuestas: respuestas,
                proceso: '2025-2'
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Error al procesar gabarito');
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.message || 'Error desconocido');
        }
        
        // Guardar datos y redirigir a confirmaci√≥n
        sessionStorage.setItem('gabarito_temp', JSON.stringify(data));
        window.location.href = '/gabarito/confirmar';
        
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al guardar:\n' + error.message);
    }
}
</script>