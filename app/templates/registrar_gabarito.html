{% extends "base.html" %}

{% block title %}Registrar Gabarito{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/camera-styles.css') }}">
<style>
    :root {
        --primary-blue: #2563eb;
        --bg-dark: #0f172a;
        --bg-card: #1e293b;
        --text-light: #f8fafc;
        --text-muted: #94a3b8;
        --border-color: #334155;
    }

    body {
        background: var(--bg-dark);
        color: var(--text-light);
    }

    .page-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .btn-volver {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        background: transparent;
        color: var(--text-light);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        margin-bottom: 20px;
    }

    /* Estilos para el selector de 3 m√©todos */
    .method-selector {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 32px;
    }

    .method-card {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }

    .method-card:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(59, 130, 246, 0.5);
        transform: translateY(-4px);
    }

    .method-card.active {
        background: rgba(59, 130, 246, 0.2);
        border-color: #3b82f6;
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
    }

    .method-icon {
        font-size: 48px;
        margin-bottom: 12px;
    }

    .method-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 8px;
        color: white;
    }

    .method-description {
        font-size: 14px;
        color: #94a3b8;
    }

    .section-content {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 30px;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .manual-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 12px;
        margin-top: 20px;
    }

    .pregunta-input {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .pregunta-input label {
        font-size: 0.75rem;
        color: var(--text-muted);
        font-weight: 600;
    }

    .pregunta-input select {
        padding: 8px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-light);
        font-size: 0.875rem;
    }

    .btn-guardar {
        width: 100%;
        padding: 14px;
        background: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 24px;
    }

    .btn-guardar:hover {
        background: #1d4ed8;
    }


    /* CORRECCI√ìN DEFINITIVA PARA C√ÅMARA */
    #cameraContainer {
        max-width: 600px !important;
        margin: 0 auto !important;
        overflow: hidden !important;
    }

    #cameraContainer .camera-container {
        max-width: 600px !important;
        margin: 0 auto !important;
        overflow: hidden !important;
    }

    #cameraContainer .camera-view,
    #cameraContainer .photo-preview {
        max-width: 600px !important;
        max-height: 420px !important;
        margin: 0 auto !important;
        overflow: hidden !important;
    }

    #cameraContainer video,
    #cameraContainer canvas,
    #cameraContainer img {
        max-width: 100% !important;
        max-height: 420px !important;
        width: 100% !important;
        height: auto !important;
        object-fit: contain !important;
        display: block !important;
        margin: 0 auto !important;
    }

    #cameraContainer .camera-controls {
        max-width: 600px !important;
        margin: 0 auto !important;
    }

    @media (max-width: 768px) {
        #cameraContainer .camera-view,
        #cameraContainer .photo-preview {
            max-height: 420px !important;
        }
        .method-selector {
            grid-template-columns: 1fr;
        }
        
        #cameraContainer video,
        #cameraContainer canvas,
        #cameraContainer img {
            max-height: 420px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <a href="/" class="btn-volver">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Volver
    </a>

    <div class="page-header">
        <h1>‚úÖ Registrar Respuestas Correctas</h1>
        <p>Ingresa el gabarito del examen</p>
    </div>

    <!-- Selector de m√©todo -->
    <div class="method-selector">
        <div class="method-card active" id="methodCamera" onclick="selectMethod('camera')">
            <div class="method-icon">üì∏</div>
            <div class="method-title">Capturar con C√°mara</div>
            <div class="method-description">Usa la c√°mara para escanear el gabarito</div>
        </div>

        <div class="method-card" id="methodManual" onclick="selectMethod('manual')">
            <div class="method-icon">‚å®Ô∏è</div>
            <div class="method-title">Ingreso Manual</div>
            <div class="method-description">Ingresa las respuestas manualmente</div>
        </div>
        
        <div class="method-card" id="methodVoz" onclick="selectMethod('voz')">
            <div class="method-icon">üé§</div>
            <div class="method-title">Captura por Voz</div>
            <div class="method-description">Dicta las respuestas con tu voz</div>
        </div>
    </div>

    <!-- Secci√≥n de c√°mara -->
    <div id="cameraSection" class="section-content" style="display: block;">
        <div class="camera-info">
            Coloca la hoja de respuestas correctas dentro del marco y captura
        </div>
        
        <div style="max-width: 600px; margin: 0 auto; overflow: hidden;">
            <div id="cameraContainer"></div>
        </div>

    </div>

    <!-- Secci√≥n de ingreso manual -->
    <div id="manualSection" class="section-content" style="display: none;">
        <h3>Ingresa las respuestas correctas (100 preguntas)</h3>
        
        <div class="manual-grid">
            {% for i in range(1, 101) %}
            <div class="pregunta-input">
                <label>{{ i }}</label>
                <select name="respuesta_{{ i }}" id="respuesta_{{ i }}">
                    <option value="">-</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                </select>
            </div>
            {% endfor %}
        </div>

        <button type="button" class="btn-guardar" onclick="guardarGabarito()">
            Guardar Gabarito
        </button>
    </div>

    <!-- SECCI√ìN VOZ (NUEVA) -->
    <div id="vozSection" class="section-content" style="display: none;">
        {% include "components/captura_voz_gabarito.html" %}
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='/js/camera-capture.js') }}"></script>
<script>

// ============================================================================
// REEMPLAZAR EL <script> EN registrar_gabarito.html CON ESTE C√ìDIGO
// ============================================================================

let camera;
let currentMethod = 'camera';

window.addEventListener('load', () => {
    console.log('P√°gina de gabarito cargada');
    // Iniciar con m√©todo c√°mara por defecto
    //selectMethod('camera');
    
    if (typeof CameraCapture !== 'undefined') {
        console.log('‚úÖ CameraCapture disponible');
        setTimeout(() => {
            selectMethod('camera');
        }, 300);
    } else {
        console.error('‚ùå CameraCapture no disponible');
        selectMethod('manual');
    }
});

function selectMethod(method) {
    currentMethod = method;
    console.log('M√©todo seleccionado:', method);
    
    // Referencias a elementos
    const methodCamera = document.getElementById('methodCamera');
    const methodManual = document.getElementById('methodManual');
    const methodVoz = document.getElementById('methodVoz');
    
    const cameraSection = document.getElementById('cameraSection');
    const manualSection = document.getElementById('manualSection');
    const vozSection = document.getElementById('vozSection');
    
    // Remover clase active de todas las cards
    methodCamera.classList.remove('active');
    methodManual.classList.remove('active');
    methodVoz.classList.remove('active');
    
    // Ocultar todas las secciones
    cameraSection.style.display = 'none';
    manualSection.style.display = 'none';
    vozSection.style.display = 'none';
    
    // Detener c√°mara si estaba activa
    if (camera && method !== 'camera') {
        camera.stopCamera();
    }
    
    // ========================================================================
    // M√âTODO 1: C√ÅMARA
    // ========================================================================
    if (method === 'camera') {
        methodCamera.classList.add('active');
        cameraSection.style.display = 'block';
        
        // Verificar si CameraCapture est√° disponible
        if (typeof CameraCapture === 'undefined') {
            alert('Error: Sistema de c√°mara no disponible');
            selectMethod('manual');
            return;
        }
        
        // Inicializar o reiniciar c√°mara
        if (!camera) {
            setTimeout(() => {
                inicializarCamara();
            }, 300);
        } else {
            camera.startCamera();
        }
    }
    
    // ========================================================================
    // M√âTODO 2: MANUAL
    // ========================================================================
    else if (method === 'manual') {
        methodManual.classList.add('active');
        manualSection.style.display = 'block';
    }
    
    // ========================================================================
    // M√âTODO 3: VOZ
    // ========================================================================
    else if (method === 'voz') {
        methodVoz.classList.add('active');
        vozSection.style.display = 'block';
        
        // Verificar soporte de Web Speech API
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('‚ùå Tu navegador no soporta reconocimiento de voz.\n\nPor favor usa:\n- Chrome\n- Edge\n- Safari\n\nCambiando a ingreso manual...');
            selectMethod('manual');
            return;
        }
        
        console.log('‚úÖ Captura por voz lista');
    }
}

function inicializarCamara() {
    console.log('Inicializando c√°mara para gabarito...');
    
    try {
        camera = new CameraCapture('cameraContainer', {
            width: 1920,
            height: 1440,
            imageQuality: 0.85,
            facingMode: 'environment',
            
            texts: {
                capture: 'Capturar Gabarito',
                retake: 'Tomar Otra',
                confirm: 'Procesar Gabarito',
                switchCamera: 'Cambiar C√°mara',
                loading: 'Procesando gabarito...'
            },
            
            onCameraReady: (settings) => {
                console.log('‚úÖ C√°mara lista para gabarito:', settings);
            },
            
            onConfirm: async (formData) => {
                // Cuando el usuario confirma la foto
                await procesarGabaritoImagen(formData);
            },
            
            onError: (error, message) => {
                console.error('‚ùå Error:', error);
                alert(message);
            }
        });
        
        camera.startCamera().then(() => {
            console.log('‚úÖ C√°mara iniciada para gabarito');
        }).catch(err => {
            console.error('‚ùå Error al iniciar:', err);
            alert('No se pudo acceder a la c√°mara. Cambiando a ingreso manual...');
            selectMethod('manual');
        });
        
    } catch (error) {
        console.error('‚ùå Error al crear CameraCapture:', error);
        alert('Error: ' + error.message);
        selectMethod('manual');
    }
}

// PROCESAR GABARITO DESDE IMAGEN
async function procesarGabaritoImagen(formData) {
    try {
        // Agregar proceso al FormData
        formData.append('proceso', 'ADMISION_2025_2');
        formData.append('api', 'google'); // o 'openai' o 'anthropic'
        
        const response = await fetch('/api/gabarito/procesar-imagen', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Error al procesar imagen');
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Error desconocido');
        }
        
        // Guardar datos y redirigir a confirmaci√≥n
        sessionStorage.setItem('gabarito_temp', JSON.stringify(data));
        window.location.href = '/gabarito/confirmar';
        
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al procesar imagen:\n' + error.message);
        camera.retakePhoto();
    }
}

// GUARDAR GABARITO MANUAL
async function guardarGabarito() {
    // Recolectar respuestas del formulario
    const respuestas = {};
    let faltantes = [];
    
    for (let i = 1; i <= 100; i++) {
        const select = document.getElementById('respuesta_' + i);
        const valor = select.value;
        
        if (!valor || valor === '') {
            faltantes.push(i);
        } else {
            respuestas[i.toString()] = valor.toUpperCase();
        }
    }
    
    // Validar que est√©n todas
    if (faltantes.length > 0) {
        alert('‚ö†Ô∏è Faltan respuestas en las preguntas:\n' + faltantes.join(', ') + 
              '\n\nTotal faltantes: ' + faltantes.length);
        
        // Enfocar la primera faltante
        document.getElementById('respuesta_' + faltantes[0]).focus();
        return;
    }
    
    try {
        const response = await fetch('/api/gabarito/procesar-manual', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                respuestas: respuestas,
                proceso: 'ADMISION_2025_2'
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Error al procesar gabarito');
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.message || 'Error desconocido');
        }
        
        // Guardar datos y redirigir a confirmaci√≥n
        sessionStorage.setItem('gabarito_temp', JSON.stringify(data));
        window.location.href = '/gabarito/confirmar';
        
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al guardar:\n' + error.message);
    }
}

</script>
{% endblock %}