{% extends "base.html" %}

{% block title %}Registrar Postulante - POSTULANDO{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #1976d2;
        --success: #4caf50;
        --danger: #f44336;
        --warning: #ff9800;
    }

    body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        min-height: 100vh;
        padding: 40px 20px;
    }

    .registro-container {
        max-width: 1000px;
        margin: 0 auto;
    }

    .registro-header {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 32px;
        margin-bottom: 32px;
        color: white;
    }

    .registro-header h1 {
        font-size: 32px;
        margin-bottom: 8px;
    }

    .registro-header p {
        color: #94a3b8;
        font-size: 16px;
    }

    .form-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 32px;
        margin-bottom: 24px;
        color: white;
    }

    .form-section-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 24px;
        padding-bottom: 12px;
        border-bottom: 2px solid rgba(59, 130, 246, 0.3);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-label {
        font-weight: 600;
        font-size: 14px;
        color: #e2e8f0;
    }

    .form-label.required::after {
        content: " *";
        color: #f87171;
    }

    .form-input {
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        font-size: 15px;
        transition: all 0.3s;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(255, 255, 255, 0.15);
    }

    .form-input.valid {
        border-color: var(--success);
    }

    .form-input.invalid {
        border-color: var(--danger);
    }

    .form-feedback {
        font-size: 13px;
        margin-top: 4px;
    }

    .form-feedback.success {
        color: #4ade80;
    }

    .form-feedback.error {
        color: #f87171;
    }

    .file-upload {
        position: relative;
    }

    .file-upload-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 40px 20px;
        background: rgba(59, 130, 246, 0.1);
        border: 2px dashed rgba(59, 130, 246, 0.5);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .file-upload-btn:hover {
        background: rgba(59, 130, 246, 0.2);
        border-color: var(--primary);
    }

    .file-upload-btn.has-file {
        background: rgba(76, 175, 80, 0.1);
        border-color: var(--success);
    }

    .file-preview {
        margin-top: 12px;
        display: none;
    }

    .file-preview.show {
        display: block;
    }

    .file-preview img {
        max-width: 200px;
        border-radius: 8px;
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }

    .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .btn-submit {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, var(--primary), #1565c0);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
    }

    .btn-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-overlay.show {
        display: flex;
    }

    .loading-content {
        background: white;
        color: #0f172a;
        padding: 48px;
        border-radius: 16px;
        text-align: center;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 6px solid #e5e7eb;
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 24px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .alerta-certificado {
        background: rgba(255, 152, 0, 0.1);
        border: 2px solid #ff9800;
        border-radius: 12px;
        padding: 16px;
        margin-top: 12px;
        display: none;
    }

    .alerta-certificado.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="registro-container">
    
    <!-- Header -->
    <div class="registro-header">
        <h1>üìù Registrar Nuevo Postulante</h1>
        <p>Complete todos los campos requeridos (*) para registrar al postulante</p>
    </div>

    <form id="formRegistro" enctype="multipart/form-data">
        
        <!-- Secci√≥n 1: Datos Personales -->
        <div class="form-card">
            <div class="form-section-title">
                <span>üë§</span>
                <span>Datos Personales</span>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">DNI</label>
                    <input type="text" 
                           class="form-input" 
                           id="dni" 
                           name="dni" 
                           maxlength="8" 
                           pattern="[0-9]{8}"
                           required>
                    <div class="form-feedback" id="dni-feedback"></div>
                </div>

                <div class="form-group">
                    <label class="form-label required">Nombres</label>
                    <input type="text" class="form-input" id="nombres" name="nombres" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Apellido Paterno</label>
                    <input type="text" class="form-input" id="apellido_paterno" name="apellido_paterno" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Apellido Materno</label>
                    <input type="text" class="form-input" id="apellido_materno" name="apellido_materno" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Fecha de Nacimiento</label>
                    <input type="date" class="form-input" id="fecha_nacimiento" name="fecha_nacimiento" required>
                    <div class="form-feedback" id="edad-feedback"></div>
                </div>

                <div class="form-group">
                    <label class="form-label required">Sexo</label>
                    <select class="form-input" id="sexo" name="sexo" required>
                        <option value="">Seleccione...</option>
                        <option value="M">Masculino</option>
                        <option value="F">Femenino</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 2: Contacto -->
        <div class="form-card">
            <div class="form-section-title">
                <span>üìû</span>
                <span>Informaci√≥n de Contacto</span>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Celular</label>
                    <input type="tel" class="form-input" id="celular" name="celular" pattern="[0-9]{9}" maxlength="9" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Tel√©fono Fijo</label>
                    <input type="tel" class="form-input" id="telefono" name="telefono">
                </div>

                <div class="form-group full-width">
                    <label class="form-label required">Email</label>
                    <input type="email" class="form-input" id="email" name="email" required>
                </div>

                <div class="form-group full-width">
                    <label class="form-label required">Direcci√≥n</label>
                    <input type="text" class="form-input" id="direccion" name="direccion" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Distrito</label>
                    <input type="text" class="form-input" id="distrito" name="distrito" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Provincia</label>
                    <input type="text" class="form-input" id="provincia" name="provincia" value="Maynas" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Departamento</label>
                    <input type="text" class="form-input" id="departamento" name="departamento" value="Loreto" required>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 3: Datos Acad√©micos -->
        <div class="form-card">
            <div class="form-section-title">
                <span>üéì</span>
                <span>Informaci√≥n Acad√©mica</span>
            </div>
            
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label required">Programa Educativo</label>
                    <select class="form-input" id="programa_educativo" name="programa_educativo" required>
                        <option value="">Seleccione un programa...</option>
                        <option value="Contabilidad">Contabilidad</option>
                        <option value="Enfermer√≠a T√©cnica">Enfermer√≠a T√©cnica</option>
                        <option value="Computaci√≥n e Inform√°tica">Computaci√≥n e Inform√°tica</option>
                        <option value="Administraci√≥n de Empresas">Administraci√≥n de Empresas</option>
                        <option value="Secretariado Ejecutivo">Secretariado Ejecutivo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label required">Colegio de Procedencia</label>
                    <input type="text" class="form-input" id="colegio_procedencia" name="colegio_procedencia" required>
                </div>

                <div class="form-group">
                    <label class="form-label">C√≥digo Modular (MINEDU)</label>
                    <input type="text" class="form-input" id="codigo_modular_colegio" name="codigo_modular_colegio">
                </div>

                <div class="form-group">
                    <label class="form-label required">A√±o de Egreso</label>
                    <input type="number" class="form-input" id="anno_egreso" name="anno_egreso" min="1990" max="2025" required>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 4: Documentos -->
        <div class="form-card">
            <div class="form-section-title">
                <span>üìÑ</span>
                <span>Documentos Requeridos</span>
            </div>
            
            <div class="form-grid">
                <!-- Foto -->
                <div class="form-group">
                    <label class="form-label required">Foto del Postulante</label>
                    <div class="file-upload">
                        <label for="foto" class="file-upload-btn" id="foto-label">
                            <span>üì∑</span>
                            <span>Subir Foto (JPG)</span>
                        </label>
                        <input type="file" id="foto" name="foto" accept="image/jpeg,image/jpg" hidden required>
                    </div>
                    <div class="file-preview" id="foto-preview"></div>
                </div>

                <!-- DNI escaneado -->
                <div class="form-group">
                    <label class="form-label required">DNI Escaneado</label>
                    <div class="file-upload">
                        <label for="dni_archivo" class="file-upload-btn" id="dni-archivo-label">
                            <span>ü™™</span>
                            <span>Subir DNI (PDF/JPG)</span>
                        </label>
                        <input type="file" id="dni_archivo" name="dni_archivo" accept="image/*,application/pdf" hidden required>
                    </div>
                    <div class="file-preview" id="dni-archivo-preview"></div>
                </div>

                <!-- Certificado -->
                <div class="form-group full-width">
                    <label class="form-label required">Certificado de Estudios</label>
                    <div class="file-upload">
                        <label for="certificado" class="file-upload-btn" id="certificado-label">
                            <span>üìú</span>
                            <span>Subir Certificado (PDF)</span>
                        </label>
                        <input type="file" id="certificado" name="certificado" accept="application/pdf" hidden required>
                    </div>
                    <div class="file-preview" id="certificado-preview"></div>
                    
                    <div class="alerta-certificado" id="alerta-certificado">
                        <strong>‚ö†Ô∏è Importante:</strong>
                        El sistema verificar√° autom√°ticamente si el certificado est√° registrado en MINEDU.
                        Si NO est√° registrado, el postulante NO podr√° ser ingresado posteriormente al sistema REGISTRA.
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 5: Consideraciones Especiales -->
        <div class="form-card">
            <div class="form-section-title">
                <span>‚ôø</span>
                <span>Consideraciones Especiales</span>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="tiene_discapacidad" name="tiene_discapacidad">
                <label for="tiene_discapacidad">El postulante tiene alguna discapacidad</label>
            </div>

            <div id="discapacidad-detalles" style="display: none; margin-top: 16px;">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Tipo de Discapacidad</label>
                        <input type="text" class="form-input" id="tipo_discapacidad" name="tipo_discapacidad">
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">Observaciones Especiales</label>
                        <textarea class="form-input" id="observaciones_especiales" name="observaciones_especiales" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 6: Pago -->
        <div class="form-card">
            <div class="form-section-title">
                <span>üí∞</span>
                <span>Pago de Carpeta</span>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">M√©todo de Pago</label>
                    <select class="form-input" id="metodo_pago" name="metodo_pago" required>
                        <option value="">Seleccione...</option>
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia Bancaria</option>
                        <option value="Yape">Yape</option>
                        <option value="Plin">Plin</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label required">Monto</label>
                    <input type="number" class="form-input" id="monto_carpeta" name="monto_carpeta" value="50.00" step="0.01" required>
                </div>

                <div class="form-group" id="grupo-numero-operacion" style="display: none;">
                    <label class="form-label">N√∫mero de Operaci√≥n</label>
                    <input type="text" class="form-input" id="numero_operacion" name="numero_operacion">
                </div>
            </div>
        </div>

        <!-- Bot√≥n de Submit -->
        <button type="submit" class="btn-submit" id="btn-submit">
            ‚úÖ Registrar Postulante
        </button>
    </form>

</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h3>Registrando postulante...</h3>
        <p>Por favor espere</p>
    </div>
</div>

<script>
// ============================================================================
// VALIDACI√ìN Y MANEJO DEL FORMULARIO
// ============================================================================

// Validaci√≥n de DNI en tiempo real
document.getElementById('dni').addEventListener('input', async function(e) {
    const dni = e.target.value;
    const feedback = document.getElementById('dni-feedback');
    
    if (dni.length === 8) {
        feedback.textContent = 'Validando DNI...';
        feedback.className = 'form-feedback';
        
        // TODO: Consultar API RENIEC
        // Por ahora, validar formato
        const valido = /^[0-9]{8}$/.test(dni);
        
        if (valido) {
            e.target.classList.add('valid');
            e.target.classList.remove('invalid');
            feedback.textContent = '‚úì DNI v√°lido';
            feedback.classList.add('success');
        } else {
            e.target.classList.add('invalid');
            e.target.classList.remove('valid');
            feedback.textContent = '‚úó DNI inv√°lido';
            feedback.classList.add('error');
        }
    } else {
        e.target.classList.remove('valid', 'invalid');
        feedback.textContent = '';
    }
});

// Calcular edad
document.getElementById('fecha_nacimiento').addEventListener('change', function(e) {
    const fecha = new Date(e.target.value);
    const hoy = new Date();
    let edad = hoy.getFullYear() - fecha.getFullYear();
    const mes = hoy.getMonth() - fecha.getMonth();
    
    if (mes < 0 || (mes === 0 && hoy.getDate() < fecha.getDate())) {
        edad--;
    }
    
    const feedback = document.getElementById('edad-feedback');
    feedback.textContent = `Edad: ${edad} a√±os`;
    feedback.className = 'form-feedback success';
});

// Manejo de archivos
['foto', 'dni_archivo', 'certificado'].forEach(id => {
    document.getElementById(id).addEventListener('change', function(e) {
        const file = e.target.files[0];
        const label = document.getElementById(id + '-label');
        const preview = document.getElementById(id + '-preview');
        
        if (file) {
            label.classList.add('has-file');
            label.querySelector('span:last-child').textContent = file.name;
            
            // Preview de im√°genes
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    preview.innerHTML = `<img src="${event.target.result}" alt="Preview">`;
                    preview.classList.add('show');
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = `<p>‚úì Archivo cargado: ${file.name}</p>`;
                preview.classList.add('show');
            }
        }
    });
});

// Mostrar alerta de certificado
document.getElementById('certificado').addEventListener('change', function() {
    document.getElementById('alerta-certificado').classList.add('show');
});

// Mostrar/ocultar detalles de discapacidad
document.getElementById('tiene_discapacidad').addEventListener('change', function(e) {
    const detalles = document.getElementById('discapacidad-detalles');
    detalles.style.display = e.target.checked ? 'block' : 'none';
});

// Mostrar n√∫mero de operaci√≥n si no es efectivo
document.getElementById('metodo_pago').addEventListener('change', function(e) {
    const grupo = document.getElementById('grupo-numero-operacion');
    grupo.style.display = e.target.value !== 'Efectivo' ? 'block' : 'none';
});

// Submit del formulario
document.getElementById('formRegistro').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const loadingOverlay = document.getElementById('loading-overlay');
    const btnSubmit = document.getElementById('btn-submit');
    
    try {
        // Mostrar loading
        loadingOverlay.classList.add('show');
        btnSubmit.disabled = true;
        
        const response = await fetch('/api/postulantes/registrar', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert(`‚úÖ Postulante registrado exitosamente!\n\nC√≥digo: ${result.codigo_postulante}`);
            window.location.href = '/postulantes/lista';
        } else {
            throw new Error(result.detail || result.message || 'Error al registrar');
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al registrar: ' + error.message);
    } finally {
        loadingOverlay.classList.remove('show');
        btnSubmit.disabled = false;
    }
});
</script>
{% endblock %}