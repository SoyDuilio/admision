<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Coordinador | POSTULANDO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/admin/base.css">
    <link rel="stylesheet" href="/static/css/admin/dashboard_coordinador.css">
</head>
<body>
    <!-- ============================================================ -->
    <!-- HEADER FIJO -->
    <!-- ============================================================ -->
    <header class="header">
        <div class="header-left">
            <h1>üìä Panel del Coordinador</h1>
            <span>I.S.T. Pedro A. del √Åguila H. | Proceso: {{ proceso_actual }}</span>
        </div>
        <div class="header-right">
            <span class="user-badge">üë§ {{ usuario.nombres }} {{ usuario.apellidos }}</span>
            <a href="/" class="btn-logout">üè† Sistema</a>
            <a href="/admin/logout" class="btn-logout">üö™ Salir</a>
        </div>
    </header>

    <!-- ============================================================ -->
    <!-- NAVEGACI√ìN POR PESTA√ëAS -->
    <!-- ============================================================ -->
    <nav class="tabs-nav">
        <button class="tab-btn active" data-tab="tab-postulantes">
            üë• Postulantes
            <span class="badge" id="badgePostulantes">{{ stats.total_postulantes or 0 }}</span>
        </button>
        <button class="tab-btn" data-tab="tab-aulas">
            üè´ Aulas
            <span class="badge" id="badgeAulas">{{ stats.total_aulas or 0 }}</span>
        </button>
        <button class="tab-btn" data-tab="tab-profesores">
            üë®‚Äçüè´ Profesores
            <span class="badge" id="badgeProfesores">{{ stats.total_profesores or 0 }}</span>
        </button>
        <button class="tab-btn" data-tab="tab-generacion">
            üìÑ Generar Hojas
        </button>
        <button class="tab-btn" data-tab="tab-listados">
            üìÑ Listados
        </button>
        <button class="tab-btn" data-tab="tab-asistencia">
            ‚úÖ Asistencia
            <span class="badge" id="badgeAsistencia">0</span>
        </button>
    </nav>

    <!-- ============================================================ -->
    <!-- CONTENEDOR PRINCIPAL -->
    <!-- ============================================================ -->
    <main class="main-container">
        <div class="container">
            
            <!-- ======================================================== -->
            <!-- TAB: POSTULANTES -->
            <!-- ======================================================== -->
            <div id="tab-postulantes" class="tab-content active">
                
                <!-- Estad√≠sticas r√°pidas -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="icon">üë•</div>
                        <div class="value">{{ stats.total_postulantes or 0 }}</div>
                        <div class="label">Total Postulantes</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">‚úÖ</div>
                        <div class="value">{{ stats.postulantes_asignados or 0 }}</div>
                        <div class="label">Con Aula Asignada</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">üìù</div>
                        <div class="value">{{ stats.hojas_procesadas or 0 }}</div>
                        <div class="label">Ex√°menes Procesados</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìù Registrar Postulante</h3>
                        <button class="btn btn-outline" onclick="document.getElementById('seccionCargaMasiva').classList.toggle('hidden')">
                            üì§ Carga Masiva
                        </button>
                    </div>
                    
                    <!-- Formulario de registro individual -->
                    <form id="formPostulante" onsubmit="registrarPostulante(event)" class="form-postulante">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">DNI *</label>
                                <input type="text" name="dni" class="form-control" maxlength="8" pattern="\d{8}" required placeholder="12345678">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nombres *</label>
                                <input type="text" name="nombres" class="form-control" required placeholder="Juan Carlos">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Apellido Paterno *</label>
                                <input type="text" name="apellido_paterno" class="form-control" required placeholder="Garc√≠a">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Apellido Materno *</label>
                                <input type="text" name="apellido_materno" class="form-control" required placeholder="L√≥pez">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Programa Educativo *</label>
                                <select name="programa_educativo" class="form-control" required>
                                    <option value="">-- Seleccione --</option>
                                    {% for programa in programas %}
                                    <option value="{{ programa }}">{{ programa }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-lg">üíæ Registrar Postulante</button>
                            <button type="reset" class="btn btn-outline">üîÑ Limpiar</button>
                        </div>
                    </form>
                    
                    <!-- Secci√≥n de carga masiva (oculta por defecto) -->
                    <div id="seccionCargaMasiva" class="hidden" style="margin-top: 24px; padding-top: 24px; border-top: 2px solid var(--border-light);">
                        <h4 style="margin-bottom: 16px;">üì§ Carga Masiva de Postulantes</h4>
                        <form id="formCargaMasiva" onsubmit="cargarPostulantesMasivo(event)">
                            <div class="upload-zone" id="uploadPostulantes">
                                <input type="file" id="archivoPostulantes" name="archivo" accept=".xlsx,.xls,.csv">
                                <div class="icon">üìÅ</div>
                                <h3>Arrastra tu archivo aqu√≠</h3>
                                <p>o haz clic para seleccionar</p>
                                <div class="upload-formats">
                                    <span class="upload-format">üìä Excel (.xlsx)</span>
                                    <span class="upload-format">üìÑ CSV (.csv)</span>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">üì§ Cargar Archivo</button>
                                <button type="button" class="btn btn-outline" onclick="descargarPlantilla('postulantes')">üì• Descargar Plantilla</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Lista de postulantes -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìã Lista de Postulantes</h3>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="filters-bar">
                        <div class="filter-group">
                            <label>DNI</label>
                            <input type="text" id="filtroDni" class="form-control" placeholder="Buscar DNI..." maxlength="8">
                        </div>
                        <div class="filter-group">
                            <label>Apellidos</label>
                            <input type="text" id="filtroApellidos" class="form-control" placeholder="Buscar apellidos...">
                        </div>
                        <div class="filter-group">
                            <label>Programa</label>
                            <select id="filtroPrograma" class="form-control" onchange="filtrarPostulantes()">
                                <option value="">Todos</option>
                                {% for programa in programas %}
                                <option value="{{ programa }}">{{ programa }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="filtrarPostulantes()">üîç Buscar</button>
                        </div>
                    </div>
                    
                    <!-- Tabla de postulantes -->
                    <div id="listaPostulantes">
                        <div class="text-center" style="padding: 40px;">
                            <div class="spinner"></div>
                            <p style="margin-top: 10px; color: var(--text-muted);">Cargando postulantes...</p>
                        </div>
                    </div>
                    
                    <!-- Paginaci√≥n -->
                    <div id="paginacionPostulantes"></div>
                </div>
            </div>

            <!-- ======================================================== -->
            <!-- TAB: AULAS -->
            <!-- ======================================================== -->
            <div id="tab-aulas" class="tab-content">
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üè´ Registrar Aula</h3>
                    </div>
                    
                    <!-- Configuraci√≥n de prefijo -->
                    <div class="prefix-config">
                        <label>Prefijo de c√≥digo:</label>
                        <select id="prefijoAula" name="prefijo" class="form-control" style="width: auto;">
                            <option value="AU">AU (AU-001)</option>
                            <option value="A">A (A-001)</option>
                            <option value="AULA">AULA (AULA-001)</option>
                            <option value="S">S (S-001)</option>
                        </select>
                        <span>Siguiente c√≥digo:</span>
                        <span class="prefix-preview" id="previewCodigo">AU-001</span>
                    </div>
                    
                    <form id="formAula" onsubmit="registrarAula(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nombre del Aula</label>
                                <input type="text" name="nombre" class="form-control" placeholder="Aula Magna, Lab. C√≥mputo 1...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Programa / Facultad</label>
                                <select name="programa" class="form-control">
                                    <option value="">-- General --</option>
                                    {% for programa in programas %}
                                    <option value="{{ programa }}">{{ programa }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Pabell√≥n / Edificio</label>
                                <input type="text" name="pabellon" class="form-control" placeholder="A, B, Principal...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Piso</label>
                                <input type="text" name="piso" class="form-control" placeholder="1, 2, 3...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">N√∫mero Original</label>
                                <input type="text" name="numero" class="form-control" placeholder="101, 202...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Capacidad *</label>
                                <input type="number" name="capacidad" class="form-control" min="1" max="100" required placeholder="30">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-lg">üíæ Registrar Aula</button>
                        </div>
                    </form>
                </div>

                <!-- Lista de aulas -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìã Aulas Registradas</h3>
                    </div>
                    <div id="listaAulas">
                        <div class="text-center" style="padding: 40px;">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ======================================================== -->
            <!-- TAB: PROFESORES -->
            <!-- ======================================================== -->
            <div id="tab-profesores" class="tab-content">
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üë®‚Äçüè´ Registrar Profesor / Vigilante</h3>
                        <button class="btn btn-outline" onclick="document.getElementById('seccionCargaProfesores').classList.toggle('hidden')">
                            üì§ Carga Masiva
                        </button>
                    </div>
                    
                    <form id="formProfesor" onsubmit="registrarProfesor(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">DNI *</label>
                                <input type="text" name="dni" class="form-control" maxlength="8" pattern="\d{8}" required placeholder="12345678">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nombres *</label>
                                <input type="text" name="nombres" class="form-control" required placeholder="Mar√≠a Elena">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Apellido Paterno *</label>
                                <input type="text" name="apellido_paterno" class="form-control" required placeholder="Rodr√≠guez">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Apellido Materno</label>
                                <input type="text" name="apellido_materno" class="form-control" placeholder="S√°nchez">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Condici√≥n *</label>
                                <select name="condicion" class="form-control" required>
                                    <option value="DOCENTE">Docente de la instituci√≥n</option>
                                    <option value="ADMINISTRATIVO">Personal administrativo</option>
                                    <option value="EXTERNO">Externo (contratado)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" name="email" class="form-control" placeholder="correo@ejemplo.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tel√©fono</label>
                                <input type="text" name="telefono" class="form-control" placeholder="999888777">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-lg">üíæ Registrar Profesor</button>
                        </div>
                    </form>
                    
                    <!-- Carga masiva de profesores -->
                    <div id="seccionCargaProfesores" class="hidden" style="margin-top: 24px; padding-top: 24px; border-top: 2px solid var(--border-light);">
                        <h4 style="margin-bottom: 16px;">üì§ Carga Masiva de Profesores</h4>
                        <form id="formCargaProfesores" onsubmit="cargarProfesoresMasivo(event)">
                            <div class="upload-zone" id="uploadProfesores">
                                <input type="file" id="archivoProfesores" name="archivo" accept=".xlsx,.xls,.csv">
                                <div class="icon">üìÅ</div>
                                <h3>Arrastra tu archivo aqu√≠</h3>
                                <p>Columnas: DNI, Nombres, Apellidos, Condici√≥n, Email, Tel√©fono</p>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">üì§ Cargar Archivo</button>
                                <button type="button" class="btn btn-outline" onclick="descargarPlantilla('profesores')">üì• Descargar Plantilla</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Lista de profesores -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìã Profesores / Vigilantes Registrados</h3>
                    </div>
                    <div id="listaProfesores">
                        <div class="text-center" style="padding: 40px;">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- ======================================================== -->
            <!-- TAB: GENERAR HOJAS (NUEVO) -->
            <!-- ======================================================== -->
            <div id="tab-generacion" class="tab-content">
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìÑ Generaci√≥n de Hojas con Asignaci√≥n Alfab√©tica</h3>
                    </div>
                    
                    <div class="alert alert-info">
                        <span class="alert-icon">‚ÑπÔ∏è</span>
                        <div>
                            <h4>Sistema Integrado V2.0</h4>
                            <p>Este proceso realiza autom√°ticamente:</p>
                            <ul>
                                <li>‚úì Asignaci√≥n alfab√©tica de postulantes a aulas</li>
                                <li>‚úì Asignaci√≥n de profesores</li>
                                <li>‚úì Generaci√≥n de hojas con N¬∞ de orden</li>
                                <li>‚úì Registro en base de datos</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Stats previos -->
                    <div class="stats-row" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <div class="icon">üë•</div>
                            <div class="value" id="statPostulantesGen">{{ stats.total_postulantes or 0 }}</div>
                            <div class="label">Postulantes Activos</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">üè´</div>
                            <div class="value" id="statAulasGen">{{ stats.total_aulas or 0 }}</div>
                            <div class="label">Aulas Disponibles</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">üë®‚Äçüè´</div>
                            <div class="value" id="statProfesoresGen">{{ stats.total_profesores or 0 }}</div>
                            <div class="label">Profesores Activos</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">üìã</div>
                            <div class="value" id="statAsignadosGen">{{ stats.postulantes_asignados or 0 }}</div>
                            <div class="label">Ya Asignados</div>
                        </div>
                    </div>
                    
                    <!-- Opciones de generaci√≥n -->
                    <form id="formGenerarHojas" onsubmit="ejecutarGeneracionCompleta(event)">
                        <div class="form-group">
                            <label class="form-label">Modo de Generaci√≥n</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="modo_generacion" value="unico" checked>
                                    <span class="radio-label">
                                        <strong>ZIP √önico</strong>
                                        <small>Un solo archivo con todas las hojas (recomendado)</small>
                                    </span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="modo_generacion" value="individual">
                                    <span class="radio-label">
                                        <strong>ZIP por Aula</strong>
                                        <small>Un archivo ZIP por cada aula</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Proceso de Admisi√≥n</label>
                            <input type="text" name="proceso_admision" class="form-control" value="{{ proceso_actual }}" readonly>
                        </div>
                        
                        <div class="alert alert-warning">
                            <span class="alert-icon">‚ö†Ô∏è</span>
                            <div>
                                <h4>Advertencia Importante</h4>
                                <p>Esta acci√≥n:</p>
                                <ul>
                                    <li>‚Ä¢ Eliminar√° asignaciones existentes del proceso {{ proceso_actual }}</li>
                                    <li>‚Ä¢ Reasignar√° alfab√©ticamente TODOS los postulantes activos</li>
                                    <li>‚Ä¢ Generar√° nuevas hojas con N¬∞ de orden</li>
                                    <li>‚Ä¢ No se puede deshacer f√°cilmente</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-danger" onclick="limpiarProceso()">
                                üóëÔ∏è Limpiar Proceso
                            </button>
                            <button type="button" class="btn btn-outline" onclick="verificarPreRequisitos()">
                                üîç Verificar Pre-requisitos
                            </button>
                            <button type="submit" class="btn btn-success btn-lg" id="btnGenerar">
                                üöÄ Ejecutar Asignaci√≥n y Generaci√≥n
                            </button>
                        </div>
                    </form>
                    
                    <!-- Resultado -->
                    <div id="resultadoGeneracion" class="hidden" style="margin-top: 24px;">
                        <h4>üìä Resultado de la Generaci√≥n</h4>
                        <div id="resultadoContenido"></div>
                    </div>

                    <!-- ============================================ -->
                    <!-- NUEVO: OPCIONES POST-GENERACI√ìN -->
                    <!-- ============================================ -->
                    <div id="opcionesPostGeneracion" class="hidden" style="margin-top: 24px; padding-top: 24px; border-top: 2px solid var(--border-light);">
                        <h4>üìã Listas de Control Generadas</h4>
                        <p style="color: var(--text-muted); margin-bottom: 16px;">
                            Descargue las listas de control para cada aula (para los profesores vigilantes).
                        </p>
                        
                        <div id="listasControlAulasGeneracion"></div>
                        
                        <button class="btn btn-primary" onclick="descargarTodasLasListas()" style="margin-top: 16px;">
                            üì• Descargar Todas las Listas
                        </button>
                    </div>

                </div>
                
            </div>

            <!-- ======================================================== -->
            <!-- TAB: LISTADOS -->
            <!-- ======================================================== -->
            <div id="tab-listados" class="tab-content">
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìÑ Generar Listados</h3>
                    </div>
                    
                    <div class="listados-options">
                        <div class="listado-option selected" data-listado="alfabetico">
                            <div class="icon">üìã</div>
                            <h3>Lista Alfab√©tica General</h3>
                            <p>Todos los postulantes ordenados alfab√©ticamente con su aula asignada</p>
                        </div>
                        
                        <div class="listado-option" data-listado="por-aula">
                            <div class="icon">üè´</div>
                            <h3>Lista por Aula</h3>
                            <p>Postulantes de un aula espec√≠fica para control del profesor vigilante</p>
                        </div>
                        
                        <div class="listado-option" data-listado="por-programa">
                            <div class="icon">üìö</div>
                            <h3>Lista por Programa</h3>
                            <p>Postulantes agrupados por programa educativo</p>
                        </div>
                        
                        <div class="listado-option" data-listado="control-profesores">
                            <div class="icon">‚úÖ</div>
                            <h3>Listas de Control (Profesores)</h3>
                            <p>Para marcar asistencia el d√≠a del examen</p>
                        </div>
                    </div>
                    
                    <!-- Configuraci√≥n adicional para lista por aula -->
                    <div id="config-por-aula" class="hidden" style="margin-top: 20px;">
                        <div class="form-group">
                            <label class="form-label">Seleccione el Aula</label>
                            <select id="listadoAula" class="form-control">
                                <option value="">-- Seleccione --</option>
                                {% for aula in aulas %}
                                <option value="{{ aula.id }}">{{ aula.codigo }} - {{ aula.nombre or 'Sin nombre' }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- ============================================ -->
                    <!-- NUEVO: SECCI√ìN DE LISTAS DE CONTROL -->
                    <!-- ============================================ -->
                    <div id="config-control-profesores" class="hidden" style="margin-top: 20px;">
                        <div class="alert alert-info" style="margin-bottom: 16px;">
                            <span class="alert-icon">‚ÑπÔ∏è</span>
                            <div>
                                <h4>Listas de Control para Profesores Vigilantes</h4>
                                <p>Estas listas incluyen checkbox para marcar postulantes ausentes (NO ASISTI√ì).</p>
                                <p><strong>Imprima una lista por cada aula antes del d√≠a del examen.</strong></p>
                            </div>
                        </div>
                        
                        <div id="listasControlAulas" style="margin: 16px 0;">
                            <p style="text-align: center; color: #6c757d;">
                                <span style="font-size: 2rem;">‚è≥</span><br>
                                Cargando aulas con asignaciones...
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button class="btn btn-primary" onclick="abrirTodasLasListasControl()">
                                üì• Abrir Todas las Listas
                            </button>
                            <button class="btn btn-outline" onclick="cargarListasControl()">
                                üîÑ Recargar
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-actions" style="margin-top: 20px;">
                        <button id="btnGenerarListado" class="btn btn-primary btn-lg" onclick="generarListado(document.querySelector('.listado-option.selected')?.dataset.listado || 'alfabetico')">
                            üìÑ Generar Listado
                        </button>
                        <button class="btn btn-success btn-lg" onclick="imprimirListado()">üñ®Ô∏è Imprimir</button>
                    </div>
                </div>

                <!-- Vista previa del listado -->
                <div class="card hidden" id="previewListadoCard">
                    <div class="card-header">
                        <h3 class="card-title">üëÅÔ∏è Vista Previa</h3>
                        <div>
                            <button class="btn btn-outline" onclick="imprimirListado()">üñ®Ô∏è Imprimir</button>
                            <button class="btn btn-success" onclick="descargarListadoPDF()">üì• Descargar PDF</button>
                        </div>
                    </div>
                    <div id="previewListado" class="listado-preview"></div>
                </div>
            </div>


            <!-- ======================================================== -->
            <!-- TAB: ASISTENCIA -->
            <!-- ======================================================== -->
            <div id="tab-asistencia" class="tab-content">
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‚úÖ Registro de Asistencia por Aula</h3>
                    </div>
                    
                    <div class="alert alert-info">
                        <span class="alert-icon">‚ÑπÔ∏è</span>
                        <div>
                            <h4>Instrucciones</h4>
                            <p>Seleccione el aula y marque √∫nicamente los postulantes <strong>AUSENTES</strong>.</p>
                            <p>Por defecto, todos est√°n marcados como <strong>PRESENTES</strong>.</p>
                        </div>
                    </div>
                    
                    <!-- Selector de Aula -->
                    <div class="form-group">
                        <label class="form-label">Seleccione el Aula</label>
                        <select id="aulaAsistencia" class="form-control" onchange="cargarPostulantesAsistencia()">
                            <option value="">-- Seleccione un aula --</option>
                        </select>
                    </div>
                    
                    <!-- Contenedor de postulantes -->
                    <div id="contenedorAsistencia" class="hidden" style="margin-top: 20px;">
                        
                        <div id="infoAulaAsistencia" style="background: #e9ecef; padding: 12px; border-radius: 4px; margin-bottom: 16px;">
                            <!-- Info din√°mica del aula -->
                        </div>
                        
                        <div id="listaPostulantesAsistencia">
                            <!-- Lista din√°mica de postulantes -->
                        </div>
                        
                        <div class="form-actions" style="margin-top: 20px;">
                            <button type="button" class="btn btn-success btn-lg" onclick="guardarAsistencia()">
                                üíæ Guardar Asistencia
                            </button>
                            <button type="button" class="btn btn-outline" onclick="marcarTodosPresentes()">
                                ‚úÖ Marcar Todos Presentes
                            </button>
                            <button type="button" class="btn btn-outline" onclick="cargarPostulantesAsistencia()">
                                üîÑ Recargar
                            </button>
                        </div>
                    </div>
                </div>
                
            </div>

        </div>
    </main>

    <!-- ============================================================ -->
    <!-- FOOTER FIJO -->
    <!-- ============================================================ -->
    <footer class="footer">
        <div class="footer-stats">
            <div class="footer-stat">
                <span>üë•</span>
                <span>Postulantes:</span>
                <span class="footer-stat-value" id="footerPostulantes">{{ stats.total_postulantes or 0 }}</span>
            </div>
            <div class="footer-stat">
                <span>üè´</span>
                <span>Aulas:</span>
                <span class="footer-stat-value" id="footerAulas">{{ stats.total_aulas or 0 }}</span>
            </div>
            <div class="footer-stat">
                <span>üë®‚Äçüè´</span>
                <span>Profesores:</span>
                <span class="footer-stat-value" id="footerProfesores">{{ stats.total_profesores or 0 }}</span>
            </div>
        </div>
        <div>
            <span>Proceso: <strong>{{ proceso_actual }}</strong></span>
        </div>
    </footer>

    <!-- ============================================================ -->
    <!-- MODALES -->
    <!-- ============================================================ -->
    
    <!-- Modal Editar Postulante -->
    <div id="modalEditarPostulante" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">‚úèÔ∏è Editar Postulante</h3>
                <button class="modal-close" onclick="cerrarModal('modalEditarPostulante')">√ó</button>
            </div>
            <form onsubmit="guardarEdicionPostulante(event)">
                <div class="modal-body">
                    <input type="hidden" id="editId" name="id">
                    <div class="form-group">
                        <label class="form-label">DNI</label>
                        <input type="text" id="editDni" name="dni" class="form-control" maxlength="8" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombres</label>
                            <input type="text" id="editNombres" name="nombres" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Apellido Paterno</label>
                            <input type="text" id="editApellidoPaterno" name="apellido_paterno" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Apellido Materno</label>
                            <input type="text" id="editApellidoMaterno" name="apellido_materno" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Programa</label>
                            <select id="editPrograma" name="programa_educativo" class="form-control">
                                {% for programa in programas %}
                                <option value="{{ programa }}">{{ programa }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="cerrarModal('modalEditarPostulante')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Aula -->
    <div id="modalEditarAula" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">‚úèÔ∏è Editar Aula</h3>
                <button class="modal-close" onclick="cerrarModal('modalEditarAula')">√ó</button>
            </div>
            <form onsubmit="guardarEdicionAula(event)">
                <div class="modal-body">
                    <input type="hidden" id="editAulaId" name="id">
                    <div class="form-group">
                        <label class="form-label">Nombre</label>
                        <input type="text" id="editAulaNombre" name="nombre" class="form-control">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Programa</label>
                            <input type="text" id="editAulaPrograma" name="programa" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pabell√≥n</label>
                            <input type="text" id="editAulaPabellon" name="pabellon" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Piso</label>
                            <input type="text" id="editAulaPiso" name="piso" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√∫mero</label>
                            <input type="text" id="editAulaNumero" name="numero" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Capacidad</label>
                            <input type="number" id="editAulaCapacidad" name="capacidad" class="form-control" min="1">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="cerrarModal('modalEditarAula')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- SCRIPTS -->
    <!-- ============================================================ -->

<!-- ============================================================ -->
    <!-- SCRIPTS -->
    <!-- ============================================================ -->

    <script>
        // ============================================================================
        // VERIFICAR PRE-REQUISITOS
        // ============================================================================
        
        async function verificarPreRequisitos() {
            try {
                const response = await fetch('/api/verificar-asignaciones-completas?proceso={{ proceso_actual }}');
                const data = await response.json();
                
                let mensaje = 'üìä PRE-REQUISITOS:\n\n';
                mensaje += `‚úì Postulantes activos: ${data.total_postulantes}\n`;
                mensaje += `‚úì Aulas disponibles: ${data.total_aulas}\n`;
                mensaje += `‚úì Profesores activos: ${data.total_profesores}\n`;
                mensaje += `\n`;
                
                if (data.total_postulantes === 0) {
                    mensaje += `‚ùå ERROR: No hay postulantes activos`;
                    alert(mensaje);
                    return;
                }
                
                if (data.total_aulas === 0) {
                    mensaje += `‚ùå ERROR: No hay aulas disponibles`;
                    alert(mensaje);
                    return;
                }
                
                if (data.total_profesores === 0) {
                    mensaje += `‚ùå ERROR: No hay profesores activos`;
                    alert(mensaje);
                    return;
                }
                
                mensaje += `‚úÖ Todo listo para generar hojas`;
                alert(mensaje);
                
            } catch (error) {
                alert('Error al verificar: ' + error.message);
            }
        }

        // ============================================================================
        // EJECUTAR GENERACI√ìN COMPLETA
        // ============================================================================
        
        async function ejecutarGeneracionCompleta(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const modo = formData.get('modo_generacion');
            const proceso = formData.get('proceso_admision');
            
            if (!confirm(`¬øCONFIRMAR GENERACI√ìN?\n\nModo: ${modo === 'unico' ? 'ZIP √önico' : 'ZIP por Aula'}\nProceso: ${proceso}\n\nEsto reasignar√° TODOS los postulantes alfab√©ticamente.`)) {
                return;
            }
            
            const btn = document.getElementById('btnGenerar');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Procesando... (puede tomar varios minutos)';
            
            document.getElementById('resultadoGeneracion').classList.remove('hidden');
            document.getElementById('resultadoContenido').innerHTML = '<p>üîÑ Iniciando...</p>';
            
            try {
                const response = await fetch('/api/asignar-y-generar-hojas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        proceso_admision: proceso,
                        modo_generacion: modo
                    })
                });
                
                if (modo === 'unico') {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `hojas_${proceso}_${new Date().getTime()}.zip`;
                    a.click();
                    
                    const totalHojas = response.headers.get('X-Total-Hojas') || '?';
                    
                    document.getElementById('resultadoContenido').innerHTML = `
                        <div class="alert alert-success">
                            <h4>‚úÖ Generaci√≥n Completada</h4>
                            <p><strong>Total hojas generadas:</strong> ${totalHojas}</p>
                            <p><strong>Archivo:</strong> Descargado autom√°ticamente</p>
                        </div>
                    `;
                } else {
                    const data = await response.json();
                    let html = `
                        <div class="alert alert-success">
                            <h4>‚úÖ Generaci√≥n Completada</h4>
                            <p><strong>Total hojas:</strong> ${data.total_hojas}</p>
                            <p><strong>Total aulas:</strong> ${data.total_aulas}</p>
                        </div>
                        <h5>Archivos por Aula:</h5>
                        <ul>
                    `;
                    data.archivos.forEach(archivo => {
                        html += `
                            <li>
                                <strong>${archivo.aula}</strong>: ${archivo.cantidad} hojas 
                                <a href="${archivo.url_descarga}" class="btn btn-sm btn-primary" download>üì• Descargar</a>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    document.getElementById('resultadoContenido').innerHTML = html;
                }
                
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Ejecutar Asignaci√≥n y Generaci√≥n';
                mostrarOpcionesListas();
                
            } catch (error) {
                document.getElementById('resultadoContenido').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>‚ùå Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Ejecutar Asignaci√≥n y Generaci√≥n';
            }
        }

        // ============================================================================
        // MOSTRAR OPCIONES DE LISTAS POST-GENERACI√ìN
        // ============================================================================
        
        async function mostrarOpcionesListas() {
            try {
                const response = await fetch('/api/verificar-asignaciones-completas?proceso={{ proceso_actual }}');
                const data = await response.json();
                
                if (data.total_asignaciones > 0) {
                    const responseAulas = await fetch('/api/aulas-con-asignaciones?proceso={{ proceso_actual }}&formato=simple');
                    const aulas = await responseAulas.json();
                    
                    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px;">';
                    
                    aulas.forEach(aula => {
                        html += `
                            <a href="/api/lista-control-aula/${aula.id}?proceso={{ proceso_actual }}" 
                               target="_blank"
                               class="btn btn-outline"
                               style="display: flex; align-items: center; justify-content: space-between; text-decoration: none;">
                                <span>üè´ ${aula.codigo}</span>
                                <span style="font-size: 0.85em; opacity: 0.7;">${aula.total} alumnos</span>
                            </a>
                        `;
                    });
                    
                    html += '</div>';
                    
                    document.getElementById('listasControlAulasGeneracion').innerHTML = html;
                    document.getElementById('opcionesPostGeneracion').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error cargando listas:', error);
            }
        }

        // ============================================================================
        // DESCARGAR TODAS LAS LISTAS
        // ============================================================================
        
        function descargarTodasLasListas() {
            alert('Esta funci√≥n abrir√° todas las listas en pesta√±as separadas.\n\nUse Ctrl+P en cada una para imprimir.');
            
            fetch('/api/aulas-con-asignaciones?proceso={{ proceso_actual }}&formato=simple')
                .then(res => res.json())
                .then(aulas => {
                    aulas.forEach((aula, index) => {
                        setTimeout(() => {
                            window.open(`/api/lista-control-aula/${aula.id}?proceso={{ proceso_actual }}`, '_blank');
                        }, index * 500);
                    });
                });
        }

        // ============================================================================
        // LIMPIAR PROCESO
        // ============================================================================
        
        async function limpiarProceso() {
            const proceso = '{{ proceso_actual }}';
            
            try {
                const response = await fetch(`/api/verificar-asignaciones-completas?proceso=${proceso}`);
                const data = await response.json();
                
                if (data.total_asignaciones === 0) {
                    alert('No hay datos para limpiar en el proceso ' + proceso);
                    return;
                }
                
                const mensaje = `‚ö†Ô∏è ADVERTENCIA: LIMPIEZA DE PROCESO ${proceso}

Esta acci√≥n eliminar√°:
- ${data.total_asignaciones} asignaciones
- Todas las hojas generadas
- Todas las respuestas capturadas

Esta operaci√≥n NO SE PUEDE DESHACER.

¬øEst√° seguro de continuar?`;
                
                if (!confirm(mensaje)) {
                    return;
                }
                
                const confirmacion = prompt('Para confirmar, escriba: ELIMINAR');
                if (confirmacion !== 'ELIMINAR') {
                    alert('Limpieza cancelada');
                    return;
                }
                
                const btnLimpiar = document.querySelector('button[onclick="limpiarProceso()"]');
                if (btnLimpiar) {
                    btnLimpiar.disabled = true;
                    btnLimpiar.innerHTML = '‚è≥ Limpiando...';
                }
                
                const responseLimpieza = await fetch('/api/limpiar-proceso', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        proceso_admision: proceso,
                        confirmar: true
                    })
                });
                
                if (!responseLimpieza.ok) {
                    const error = await responseLimpieza.json();
                    throw new Error(error.detail || 'Error en la limpieza');
                }
                
                const resultado = await responseLimpieza.json();
                
                alert(`‚úÖ Limpieza completada

Eliminados:
- ${resultado.eliminados.asignaciones} asignaciones
- ${resultado.eliminados.hojas} hojas
- ${resultado.eliminados.respuestas} respuestas

Ahora puede generar nuevamente.`);
                
                if (btnLimpiar) {
                    btnLimpiar.disabled = false;
                    btnLimpiar.innerHTML = 'üóëÔ∏è Limpiar Proceso';
                }
                
                setTimeout(() => location.reload(), 1500);
                
            } catch (error) {
                console.error('Error en limpieza:', error);
                alert('‚ùå Error: ' + error.message);
                
                const btnLimpiar = document.querySelector('button[onclick="limpiarProceso()"]');
                if (btnLimpiar) {
                    btnLimpiar.disabled = false;
                    btnLimpiar.innerHTML = 'üóëÔ∏è Limpiar Proceso';
                }
            }
        }


        // ============================================================================
        // INICIALIZACI√ìN AUTOM√ÅTICA AL CARGAR LA P√ÅGINA
        // ============================================================================
        
        console.log('üöÄ Script cargado, esperando DOM...');
        
        // Funci√≥n de inicializaci√≥n
        function inicializarEventosListados() {
            console.log('üéØ Inicializando eventos de listados...');
            
            const opciones = document.querySelectorAll('.listado-option');
            console.log(`üìã Opciones encontradas: ${opciones.length}`);
            
            if (opciones.length === 0) {
                console.error('‚ùå No se encontraron opciones de listado');
                return;
            }
            
            // Agregar click a cada opci√≥n
            opciones.forEach((opcion, index) => {
                const tipo = opcion.getAttribute('data-listado');
                console.log(`  ${index + 1}. Agregando listener a: ${tipo}`);
                
               opcion.addEventListener('click', function(e) {
                    console.log(`üñ±Ô∏è CLICK DETECTADO en: ${tipo}`);
                    console.log('‚è≥ Ejecutando seleccionarTipoListado...');
                    
                    try {
                        seleccionarTipoListado(tipo);
                        console.log('‚úÖ seleccionarTipoListado ejecutado correctamente');
                    } catch (error) {
                        console.error('‚ùå ERROR al ejecutar seleccionarTipoListado:', error);
                        console.error('Detalles:', error.message);
                        console.error('Stack:', error.stack);
                    }
                });

            });
            
            console.log('‚úÖ Eventos de listados inicializados correctamente');
        }
        
        // Ejecutar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            console.log('‚è≥ DOM a√∫n cargando, esperando...');
            document.addEventListener('DOMContentLoaded', function() {
                console.log('‚úÖ DOM cargado, inicializando...');
                inicializarEventosListados();
            });
        } else {
            console.log('‚úÖ DOM ya cargado, inicializando inmediatamente...');
            inicializarEventosListados();
        }
    </script>

    <script src="/static/js/admin/base.js"></script>
    <script src="/static/js/admin/dashboard_coordinador.js?v=3"></script>
</body>
</html>