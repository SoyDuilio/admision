{% extends "base.html" %}

{% block title %}Sistema de ExÃ¡menes - {{ settings.instituto_nombre }}{% endblock %}

{% block content %}
<div class="header-formal">
    <div class="institution-header">
        <h1>ğŸ“ SISTEMA DE EXÃMENES DE ADMISIÃ“N</h1>
        <p class="institution-name">{{ settings.instituto_nombre }}</p>
        <p class="exam-date">Proceso de AdmisiÃ³n {{ fecha_actual }}</p>
    </div>
</div>

<!-- Panel de EstadÃ­sticas -->
<div class="stats-panel">
    <div class="stat-card-formal">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-content">
            <div class="stat-number" id="total-postulantes">100</div>
            <div class="stat-description">Postulantes Inscritos</div>
        </div>
    </div>
    
    <div class="stat-card-formal stat-processing">
        <div class="stat-icon">ğŸ“</div>
        <div class="stat-content">
            <div class="stat-number" id="examenes-capturados">0</div>
            <div class="stat-description">ExÃ¡menes Capturados</div>
        </div>
    </div>
    
    <div class="stat-card-formal stat-graded">
        <div class="stat-icon">âœ…</div>
        <div class="stat-content">
            <div class="stat-number" id="examenes-calificados">0</div>
            <div class="stat-description">ExÃ¡menes Calificados</div>
        </div>
    </div>
    
    <div class="stat-card-formal stat-key">
        <div class="stat-icon">ğŸ”‘</div>
        <div class="stat-content">
            <div class="stat-number" id="clave-estado">âŒ</div>
            <div class="stat-description">Clave Cargada</div>
        </div>
    </div>
</div>

<!-- SecciÃ³n Principal: 3 MÃ³dulos -->
<div class="modules-container">
    
    <!-- MÃ“DULO 1: GENERACIÃ“N DE HOJAS -->
    <section class="module-card">
        <div class="module-header">
            <span class="module-icon">ğŸ“„</span>
            <h2>Generar Hojas de Respuestas</h2>
        </div>
        
        <div class="module-body">
            <div class="info-block info-primary">
                <strong>â„¹ï¸ InformaciÃ³n:</strong>
                <p>Este mÃ³dulo genera las hojas de respuestas individuales para cada postulante inscrito. Cada hoja incluye:</p>
                <ul>
                    <li>CÃ³digo QR Ãºnico</li>
                    <li>Espacios para DNI del postulante</li>
                    <li>CÃ³digo de aula</li>
                    <li>DNI del profesor supervisor</li>
                    <li>100 espacios para respuestas (A-E)</li>
                </ul>
            </div>
            
            <div class="action-group">
                <button id="btn-generar-hojas" class="btn-formal btn-primary-formal">
                    <span class="btn-icon">ğŸ“„</span>
                    Generar Hojas de Respuestas
                </button>
                <button id="btn-descargar-pdf" class="btn-formal btn-secondary-formal" disabled>
                    <span class="btn-icon">â¬‡ï¸</span>
                    Descargar PDF
                </button>
            </div>
            
            <div id="resultado-generacion" class="result-panel" style="display: none;"></div>
        </div>
    </section>
    
    <!-- MÃ“DULO 2: CAPTURA DE EXÃMENES -->
    <section class="module-card">
        <div class="module-header">
            <span class="module-icon">ğŸ“¸</span>
            <h2>Capturar ExÃ¡menes de Postulantes</h2>
        </div>
        
        <div class="module-body">
            <div class="info-block info-warning">
                <strong>âš ï¸ Instrucciones para el Profesor:</strong>
                <ol>
                    <li>Verificar que la hoja contenga los 3 cÃ³digos (DNI Postulante, Aula, DNI Profesor)</li>
                    <li>Activar la cÃ¡mara del dispositivo</li>
                    <li>Capturar foto clara de la hoja completa</li>
                    <li>El sistema extraerÃ¡ automÃ¡ticamente el cÃ³digo y las respuestas</li>
                </ol>
            </div>
            
            <div class="camera-section" id="camera-section-exam" style="display: none;">
                <div class="camera-viewport">
                    <video id="video-exam" autoplay playsinline></video>
                    <canvas id="canvas-exam" style="display: none;"></canvas>
                    
                    <!-- GuÃ­as de encuadre -->
                    <div class="camera-guides">
                        <div class="guide-corner tl"></div>
                        <div class="guide-corner tr"></div>
                        <div class="guide-corner bl"></div>
                        <div class="guide-corner br"></div>
                        <p class="guide-text">Centra la hoja dentro del marco</p>
                    </div>
                </div>
                
                <div class="camera-controls-formal">
                    <button id="btn-switch-camera-exam" class="btn-camera-control">
                        <span>ğŸ”„</span>
                        <span>Cambiar CÃ¡mara</span>
                    </button>
                    <button id="btn-capture-exam" class="btn-camera-capture">
                        <span>ğŸ“¸</span>
                        <span>CAPTURAR</span>
                    </button>
                    <button id="btn-close-camera-exam" class="btn-camera-control btn-danger-control">
                        <span>âŒ</span>
                        <span>Cerrar</span>
                    </button>
                </div>
            </div>
            
            <div id="preview-exam" class="preview-section" style="display: none;">
                <img id="preview-img-exam" class="preview-image-formal">
                <div class="preview-actions">
                    <button id="btn-retry-exam" class="btn-formal btn-secondary-formal">
                        <span class="btn-icon">ğŸ”„</span>
                        Tomar Otra Foto
                    </button>
                    <button id="btn-process-exam" class="btn-formal btn-success-formal">
                        <span class="btn-icon">âš¡</span>
                        Procesar Examen
                    </button>
                </div>
            </div>
            
            <div class="action-group">
                <button id="btn-activar-camara-exam" class="btn-formal btn-primary-formal">
                    <span class="btn-icon">ğŸ“·</span>
                    Activar CÃ¡mara
                </button>
            </div>
            
            <div id="resultado-examen" class="result-panel" style="display: none;"></div>
            
            <!-- Contador de exÃ¡menes capturados hoy -->
            <div class="session-counter">
                <p><strong>ğŸ“Š ExÃ¡menes capturados en esta sesiÃ³n:</strong> <span id="contador-sesion">0</span></p>
            </div>
        </div>
    </section>
    
    <!-- MÃ“DULO 3: CLAVE DE RESPUESTAS -->
    <section class="module-card module-critical">
        <div class="module-header module-header-critical">
            <span class="module-icon">ğŸ”</span>
            <h2>Capturar Clave de Respuestas Correctas</h2>
        </div>
        
        <div class="module-body">
            <div class="info-block info-danger">
                <strong>ğŸ”’ PROCESO CRÃTICO - Solo Director/Decano</strong>
                <p>Esta secciÃ³n debe ser utilizada Ãºnicamente por el Director o Decano al momento de la <strong>apertura del sobre lacrado</strong> que contiene las respuestas correctas.</p>
                <ul>
                    <li>âœ… Verificar que todos los exÃ¡menes estÃ©n capturados</li>
                    <li>âœ… Presencia de autoridades y veedores</li>
                    <li>âœ… Grabar el proceso de apertura (opcional pero recomendado)</li>
                </ul>
            </div>
            
            <div class="live-indicator-formal">
                <span class="live-pulse"></span>
                <span class="live-text">ğŸ”´ PROCESO EN VIVO</span>
            </div>
            
            <div class="camera-section" id="camera-section-key" style="display: none;">
                <div class="camera-viewport camera-viewport-key">
                    <video id="video-key" autoplay playsinline></video>
                    <canvas id="canvas-key" style="display: none;"></canvas>
                    
                    <div class="camera-guides">
                        <div class="guide-corner tl"></div>
                        <div class="guide-corner tr"></div>
                        <div class="guide-corner bl"></div>
                        <div class="guide-corner br"></div>
                        <p class="guide-text">HOJA DE RESPUESTAS CORRECTAS</p>
                    </div>
                </div>
                
                <div class="camera-controls-formal">
                    <button id="btn-switch-camera-key" class="btn-camera-control">
                        <span>ğŸ”„</span>
                        <span>Cambiar CÃ¡mara</span>
                    </button>
                    <button id="btn-capture-key" class="btn-camera-capture btn-camera-capture-key">
                        <span>ğŸ”</span>
                        <span>CAPTURAR CLAVE</span>
                    </button>
                    <button id="btn-close-camera-key" class="btn-camera-control btn-danger-control">
                        <span>âŒ</span>
                        <span>Cerrar</span>
                    </button>
                </div>
            </div>
            
            <div id="preview-key" class="preview-section" style="display: none;">
                <img id="preview-img-key" class="preview-image-formal">
                <div class="preview-actions">
                    <button id="btn-retry-key" class="btn-formal btn-secondary-formal">
                        <span class="btn-icon">ğŸ”„</span>
                        Tomar Otra Foto
                    </button>
                    <button id="btn-process-key" class="btn-formal btn-critical-formal">
                        <span class="btn-icon">ğŸ”</span>
                        Procesar Clave Oficial
                    </button>
                </div>
            </div>
            
            <div class="action-group">
                <button id="btn-activar-camara-key" class="btn-formal btn-critical-formal" disabled>
                    <span class="btn-icon">ğŸ”</span>
                    Iniciar Apertura del Sobre
                </button>
                <p class="helper-text">Se habilitarÃ¡ cuando se hayan capturado al menos 10 exÃ¡menes</p>
            </div>
            
            <div id="resultado-clave" class="result-panel" style="display: none;"></div>
        </div>
    </section>
    
</div>

<!-- MÃ“DULO 4: CALIFICACIÃ“N Y RESULTADOS -->
<section class="module-card module-results">
    <div class="module-header">
        <span class="module-icon">ğŸ†</span>
        <h2>CalificaciÃ³n y PublicaciÃ³n de Resultados</h2>
    </div>
    
    <div class="module-body">
        <div class="info-block info-success">
            <strong>âœ… Requisitos para Calificar:</strong>
            <ul>
                <li id="req-examenes">âŒ ExÃ¡menes de postulantes capturados</li>
                <li id="req-clave">âŒ Clave de respuestas correctas cargada</li>
            </ul>
        </div>
        
        <div class="action-group-large">
            <button id="btn-calificar-todos" class="btn-formal-large btn-success-large" disabled>
                <span class="btn-icon-large">ğŸš€</span>
                <span>CALIFICAR TODOS LOS EXÃMENES</span>
            </button>
            
            <button id="btn-ver-resultados" class="btn-formal-large btn-primary-large">
                <span class="btn-icon-large">ğŸ“Š</span>
                <span>VER RANKING DE INGRESANTES</span>
            </button>
            
            <button id="btn-exportar-resultados" class="btn-formal-large btn-secondary-large" disabled>
                <span class="btn-icon-large">ğŸ“¥</span>
                <span>EXPORTAR RESULTADOS (Excel)</span>
            </button>
        </div>
        
        <div id="resultado-calificacion" class="result-panel-large" style="display: none;"></div>
    </div>
</section>

<!-- Loading Overlay Profesional -->
<div id="loading-overlay-formal" class="loading-overlay-formal" style="display: none;">
    <div class="loading-content-formal">
        <div class="loading-spinner-formal"></div>
        <p class="loading-text-formal" id="loading-message">Procesando...</p>
        <p class="loading-subtext" id="loading-subtext">Por favor espere</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='/js/camera-handler.js') }}"></script>
<script src="{{ url_for('static', path='/js/exam-processor.js') }}"></script>
{% endblock %}