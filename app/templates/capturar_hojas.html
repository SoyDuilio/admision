{% extends "base.html" %}

{% block title %}Capturar Hojas{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: #000;
        color: #f8fafc;
        overflow: hidden;
        height: 100vh;
    }

    /* HEADER M√çNIMO */
    .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 12px;
        background: rgba(15, 23, 42, 0.95);
        border-bottom: 1px solid #334155;
        height: 44px;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .btn-volver {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: transparent;
        color: #f8fafc;
        border: 1px solid #334155;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.8125rem;
        font-weight: 600;
    }

    .header-title {
        font-size: 0.9375rem;
        font-weight: 700;
    }

    .header-right {
        display: flex;
        gap: 8px;
    }

    .header-link {
        padding: 4px 10px;
        color: #60a5fa;
        text-decoration: none;
        font-size: 0.8125rem;
        font-weight: 600;
        border-radius: 6px;
    }

    /* C√ÅMARA FULLSCREEN - CORREGIDO */
    .camera-fullscreen {
        position: relative;
        height: calc(100vh - 44px - 60px); /* Header + Botones */
        background: #000;
        overflow: hidden;
    }

    .camera-fullscreen #cameraView,
    .camera-fullscreen #photoPreview {
        height: 100%;
        width: 100%;
    }

    #cameraView {
        display: block;
    }

    #cameraVideo {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
    }

    #photoPreview {
        display: none;
        width: 100%;
        height: 100%;
    }

    #photoImage {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
    }

    /* MARCO AZUL */
    .camera-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 5;
    }

    .camera-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        height: 95%;
        border: 2px solid #3b82f6;
        border-radius: 8px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4);
    }

    /* STATUS MINI */
    .status-mini {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 8px;
        z-index: 10;
    }

    .status-badge {
        padding: 4px 10px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 12px;
        font-size: 0.6875rem;
        backdrop-filter: blur(10px);
        color: #94a3b8;
    }

    .status-badge.ok {
        color: #22c55e;
    }

    .status-badge.error {
        color: #ef4444;
    }

    /* BARRA DE BOTONES FIJA */
    .bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: rgba(15, 23, 42, 0.98);
        border-top: 1px solid #334155;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        padding: 0 12px;
        z-index: 100;
        backdrop-filter: blur(10px);
    }

    .btn-bottom {
        flex: 1;
        max-width: 150px;
        padding: 10px 12px;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.2s;
        font-size: 0.8125rem;
    }

    .btn-switch-cam {
        background: rgba(71, 85, 105, 0.9);
        color: white;
    }

    .btn-capture-main {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
    }

    .btn-capture-main.confirm {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }

    .btn-voice-toggle {
        background: rgba(71, 85, 105, 0.9);
        color: white;
    }

    .btn-voice-toggle.active {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }

    /* LOADING */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 200;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(37, 99, 235, 0.3);
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ALERTA GPS */
    .gps-alert {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(239, 68, 68, 0.95);
        color: white;
        padding: 24px;
        border-radius: 12px;
        text-align: center;
        z-index: 150;
        display: none;
        max-width: 400px;
        backdrop-filter: blur(10px);
    }

    .gps-alert.active {
        display: block;
    }

    /* RESULTADOS MODAL */
    .resultado-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 300;
        padding: 20px;
        overflow-y: auto;
    }

    .resultado-modal.active {
        display: flex;
    }

    .resultado-content {
        background: #1e293b;
        border-radius: 16px;
        padding: 24px;
        max-width: 500px;
        width: 100%;
        max-height: 85vh;
        overflow-y: auto;
    }

    .nota-destacada {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 20px;
    }

    .nota-destacada .value {
        font-size: 2.5rem;
        font-weight: 700;
    }

    .resultado-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }

    .resultado-item {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 8px;
    }

    .resultado-item dt {
        font-size: 0.6875rem;
        color: #94a3b8;
        margin-bottom: 4px;
    }

    .resultado-item dd {
        font-size: 0.9375rem;
        color: #f8fafc;
        font-weight: 600;
        margin: 0;
    }

    .btn-siguiente {
        width: 100%;
        padding: 12px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
    }

    /* BOT√ìN DE LINTERNA FLOTANTE */
    /* NUEVO: Bot√≥n de linterna flotante */
.torch-button {
    position: absolute;
    top: 80px; /* Debajo del status GPS */
    right: 20px;
    width: 56px;
    height: 56px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 100;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.torch-button:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: scale(1.1);
}

.torch-button:active {
    transform: scale(0.95);
}

.torch-button.active {
    background: rgba(255, 193, 7, 0.9);
    border-color: #ffc107;
    box-shadow: 0 4px 20px rgba(255, 193, 7, 0.5);
}

.torch-icon {
    font-size: 28px;
    line-height: 1;
}

/* Animaci√≥n de pulso cuando est√° activa */
.torch-button.active::before {
    content: '';
    position: absolute;
    top: -4px;
    left: -4px;
    right: -4px;
    bottom: -4px;
    border-radius: 50%;
    border: 2px solid rgba(255, 193, 7, 0.5);
    animation: torch-pulse 2s infinite;
}

@keyframes torch-pulse {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    100% {
        transform: scale(1.3);
        opacity: 0;
    }
}

.estado-visual {
    text-align: center;
    padding: 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    margin-bottom: 24px;
}

.icono-estado {
    font-size: 64px;
    margin-bottom: 12px;
}

#mensajeEstado {
    color: white;
    font-size: 1.25rem;
    margin: 0;
}

.datos-postulante {
    display: grid;
    gap: 12px;
    margin-bottom: 24px;
}

.dato-item {
    display: flex;
    justify-content: space-between;
    padding: 12px;
    background: #f8fafc;
    border-radius: 8px;
}

.dato-item .label {
    color: #64748b;
    font-size: 0.875rem;
}

.dato-item .value {
    font-weight: 600;
    color: #1e293b;
}

.detalles-tecnicos {
    margin: 16px 0;
    padding: 12px;
    background: #f1f5f9;
    border-radius: 8px;
}

.detalles-tecnicos summary {
    cursor: pointer;
    font-weight: 600;
    color: #475569;
    padding: 8px;
}

.detalle-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    padding-top: 12px;
}

.label-mini {
    display: block;
    font-size: 0.75rem;
    color: #64748b;
    margin-bottom: 4px;
}

.resultado-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}

.btn-primary, .btn-secondary {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-secondary {
    background: white;
    color: #667eea;
    border: 2px solid #667eea;
}
</style>
{% endblock %}

{% block content %}
<!-- HEADER -->
<div class="header-bar">
    <div class="header-left">
        <a href="/" class="btn-volver">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Volver
        </a>
        <span class="header-title">üì∏ Capturar Hojas</span>
    </div>
    <div class="header-right">
        <a href="/demo" class="header-link">Demo</a>
        <a href="/resultados" class="header-link">Resultados</a>
    </div>
</div>

<!-- C√ÅMARA FULLSCREEN -->
<div class="camera-fullscreen">
    <!-- Status mini -->
    <div class="status-mini">
        <div class="status-badge" id="statusGPS">üìç Obteniendo...</div>
    </div>

    <!-- Video -->
    <div id="cameraView">
        <video id="cameraVideo" autoplay playsinline></video>
        <div class="camera-overlay">
            <div class="camera-frame"></div>
        </div>
        
        <!-- NUEVO: Bot√≥n de linterna flotante -->
        <button class="torch-button" id="torchButton" style="display: none;">
            <span class="torch-icon" id="torchIcon">üî¶</span>
        </button>
    </div>

    <!-- Preview -->
    <div id="photoPreview">
        <img id="photoImage" alt="Foto capturada">
    </div>

    <!-- Canvas oculto -->
    <canvas id="photoCanvas" style="display: none;"></canvas>

    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p style="color: white; font-size: 1rem; margin-top: 16px;">Procesando con Claude AI...</p>
        <p style="color: #94a3b8; font-size: 0.8125rem; margin-top: 8px;">Extrayendo c√≥digos y respuestas</p>
    </div>

    <!-- Alerta GPS -->
    <div class="gps-alert" id="gpsAlert">
        <h3 style="margin-bottom: 12px;">‚ö†Ô∏è GPS Requerido</h3>
        <p style="margin-bottom: 16px;">Debes compartir tu ubicaci√≥n para capturar hojas. Es un requisito de seguridad del proceso de admisi√≥n.</p>
        <button onclick="solicitarGPS()" style="padding: 10px 20px; background: white; color: #ef4444; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
            Permitir Ubicaci√≥n
        </button>
    </div>
</div>

<!-- BARRA DE BOTONES FIJA -->
<div class="bottom-bar">
    <button type="button" class="btn-bottom btn-switch-cam" id="btnSwitchCam">
        üîÑ Cambiar
    </button>
    <button type="button" class="btn-bottom btn-capture-main" id="btnCapture">
        üì∏ Capturar
    </button>
    <button type="button" class="btn-bottom btn-voice-toggle" id="btnVoiceToggle">
        üé§ Usar Voz
    </button>
</div>

<!-- ============================================================================
MODAL DE RESULTADO MEJORADO
Reemplazar en capturar_hojas.html
============================================================================ -->

<div class="resultado-modal" id="resultadoModal">
    <div class="resultado-content">
        <div class="resultado-header">
            <h2 id="resultadoTitulo">‚úÖ Hoja Procesada</h2>
            <button onclick="cerrarResultado()" class="btn-close">‚úï</button>
        </div>

        <!-- Estado visual -->
        <div class="estado-visual" id="estadoVisual">
            <div class="icono-estado" id="iconoEstado">üì∏</div>
            <h3 id="mensajeEstado">Procesamiento exitoso</h3>
        </div>

        <!-- Datos del postulante -->
        <div class="datos-postulante">
            <div class="dato-item">
                <span class="label">Postulante</span>
                <span class="value" id="resultadoNombre">-</span>
            </div>
            <div class="dato-item">
                <span class="label">DNI</span>
                <span class="value" id="resultadoDni">-</span>
            </div>
            <div class="dato-item">
                <span class="label">Programa</span>
                <span class="value" id="resultadoPrograma">-</span>
            </div>
        </div>

        <!-- Nota (si existe) -->
        <div class="nota-destacada" id="seccionNota">
            <div class="nota-numero" id="resultadoNota">-</div>
            <div class="nota-detalle">
                <span class="label">Nota Final</span>
                <span class="correctas" id="resultadoCorrectas">- / 100</span>
            </div>
        </div>

        <!-- Detalles t√©cnicos (colapsable) -->
        <details class="detalles-tecnicos">
            <summary>üìã Detalles t√©cnicos</summary>
            <div class="detalle-grid">
                <div>
                    <span class="label-mini">C√≥digo Hoja</span>
                    <span id="resultadoCodigoHoja">-</span>
                </div>
                <div>
                    <span class="label-mini">API Usada</span>
                    <span id="resultadoApi">-</span>
                </div>
                <div>
                    <span class="label-mini">Tiempo</span>
                    <span id="resultadoTiempo">-</span>
                </div>
                <div>
                    <span class="label-mini">Respuestas</span>
                    <span id="resultadoRespDetectadas">-</span>
                </div>
            </div>
        </details>

        <!-- Botones -->
        <div class="resultado-actions">
            <button onclick="siguienteHoja()" class="btn-primary">
                ‚û°Ô∏è Siguiente Hoja
            </button>
            <button onclick="verDetalles()" class="btn-secondary">
                üìä Ver Detalles
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============================================================================
// VARIABLES GLOBALES
// ============================================================================
let stream;
let recognition;
let metadataCaptura = {};
let vozActiva = false;
let photoBlob = null;
let gpsObtenido = false;
let torchEnabled = false;
let currentVideoTrack = null;

// ============================================================================
// CONTROL DE LINTERNA
// ============================================================================
async function verificarLinterna() {
    const video = document.getElementById('cameraVideo');
    const torchButton = document.getElementById('torchButton');
    
    if (!video.srcObject) return;
    
    const tracks = video.srcObject.getVideoTracks();
    if (tracks.length === 0) return;
    
    currentVideoTrack = tracks[0];
    const capabilities = currentVideoTrack.getCapabilities();
    
    if (capabilities && capabilities.torch) {
        console.log('‚úÖ Linterna disponible');
        torchButton.style.display = 'flex';
        
        // Encender autom√°ticamente
        await toggleLinterna(true);
    } else {
        console.log('‚ÑπÔ∏è Linterna no disponible en este dispositivo');
        torchButton.style.display = 'none';
    }
}

async function toggleLinterna(forceState = null) {
    if (!currentVideoTrack) {
        console.warn('‚ö†Ô∏è No hay track de video disponible');
        return;
    }
    
    const torchButton = document.getElementById('torchButton');
    const torchIcon = document.getElementById('torchIcon');
    
    try {
        const newState = forceState !== null ? forceState : !torchEnabled;
        
        await currentVideoTrack.applyConstraints({
            advanced: [{ torch: newState }]
        });
        
        torchEnabled = newState;
        
        if (torchEnabled) {
            torchButton.classList.add('active');
            torchIcon.textContent = 'üí°';
            console.log('‚úÖ Linterna encendida');
        } else {
            torchButton.classList.remove('active');
            torchIcon.textContent = 'üî¶';
            console.log('‚úÖ Linterna apagada');
        }
        
    } catch (error) {
        console.error('‚ùå Error al controlar linterna:', error);
    }
}

// Event listener del bot√≥n de linterna
document.addEventListener('DOMContentLoaded', () => {
    const torchButton = document.getElementById('torchButton');
    if (torchButton) {
        torchButton.addEventListener('click', () => toggleLinterna());
    }
});

// CR√çTICO: Apagar linterna al salir
window.addEventListener('beforeunload', async () => {
    if (torchEnabled && currentVideoTrack) {
        try {
            await currentVideoTrack.applyConstraints({
                advanced: [{ torch: false }]
            });
        } catch (error) {
            console.error('Error al apagar linterna:', error);
        }
    }
});

// Apagar linterna cuando se oculta la p√°gina
document.addEventListener('visibilitychange', async () => {
    if (document.hidden && torchEnabled) {
        await toggleLinterna(false);
    }
});

// ============================================================================
// DETECCI√ìN DE CALIDAD DEL DISPOSITIVO
// ============================================================================
function detectarCalidadDispositivo() {
    const screenWidth = screen.width;
    const screenHeight = screen.height;
    const pixelRatio = window.devicePixelRatio || 1;
    
    const score = (screenWidth * screenHeight * pixelRatio) / 1000000;
    
    if (score > 5) {
        return 'high';
    } else if (score > 2) {
        return 'medium';
    } else {
        return 'low';
    }
}

// ============================================================================
// CAPTURA DE METADATA CON GPS OBLIGATORIO
// ============================================================================
async function capturarMetadata() {
    metadataCaptura = {
        timestamp: new Date().toISOString(),
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        user_agent: navigator.userAgent,
        device_fingerprint: await generarDeviceFingerprint(),
        screen: { width: screen.width, height: screen.height },
        device_quality: detectarCalidadDispositivo()
    };

    await solicitarGPS();
}

async function solicitarGPS() {
    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        });

        metadataCaptura.gps = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy
        };

        document.getElementById('statusGPS').className = 'status-badge ok';
        document.getElementById('statusGPS').textContent = 'üìç GPS ‚úì';
        document.getElementById('gpsAlert').classList.remove('active');
        gpsObtenido = true;
    } catch (error) {
        document.getElementById('statusGPS').className = 'status-badge error';
        document.getElementById('statusGPS').textContent = 'üìç GPS ‚úó';
        document.getElementById('gpsAlert').classList.add('active');
        gpsObtenido = false;
        throw new Error('GPS requerido');
    }
}

async function generarDeviceFingerprint() {
    const data = navigator.userAgent + screen.width + screen.height;
    const msgBuffer = new TextEncoder().encode(data);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 32);
}

// ============================================================================
// RECONOCIMIENTO DE VOZ
// ============================================================================
function iniciarReconocimientoVoz() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        document.getElementById('btnVoiceToggle').disabled = true;
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.continuous = true;

    recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase();
        if (transcript.includes('captur') || transcript.includes('foto')) {
            capturarFoto();
        }
    };

    recognition.onerror = (e) => {
        if (e.error === 'no-speech' && vozActiva) {
            recognition.stop();
            setTimeout(() => { if (vozActiva) recognition.start(); }, 1000);
        }
    };

    recognition.onend = () => {
        if (vozActiva) recognition.start();
    };
}

function toggleVoz() {
    vozActiva = !vozActiva;
    const btn = document.getElementById('btnVoiceToggle');
    
    if (vozActiva) {
        btn.classList.add('active');
        btn.textContent = 'üé§ Activo';
        recognition.start();
    } else {
        btn.classList.remove('active');
        btn.textContent = 'üé§ Usar Voz';
        recognition.stop();
    }
}

// ============================================================================
// C√ÅMARA CON LINTERNA
// ============================================================================
async function iniciarCamara() {
    try {
        const calidadDispositivo = detectarCalidadDispositivo();
        
        let videoConstraints = {
            width: { ideal: 1920, min: 1280 },
            height: { ideal: 1440, min: 720 },
            facingMode: 'environment'
        };
        
        stream = await navigator.mediaDevices.getUserMedia({
            video: videoConstraints,
            audio: false
        });
        
        const video = document.getElementById('cameraVideo');
        video.srcObject = stream;
        
        // Esperar a que el video est√© listo
        video.addEventListener('loadedmetadata', async () => {
            await verificarLinterna();
        });
        
    } catch (error) {
        console.error('Error al acceder a la c√°mara:', error);
        alert('No se pudo acceder a la c√°mara: ' + error.message);
    }
}

// ============================================================================
// CAMBIAR C√ÅMARA
// ============================================================================
async function cambiarCamara() {
    if (stream) {
        // Apagar linterna antes de cambiar
        if (torchEnabled) {
            await toggleLinterna(false);
        }
        
        // Detener stream actual
        stream.getTracks().forEach(track => track.stop());
        
        // Obtener c√°mara actual
        const currentFacing = stream.getVideoTracks()[0].getSettings().facingMode;
        const newFacing = currentFacing === 'environment' ? 'user' : 'environment';
        
        // Iniciar nueva c√°mara
        stream = await navigator.mediaDevices.getUserMedia({
            video: { 
                facingMode: newFacing,
                width: { ideal: 1920 },
                height: { ideal: 1440 }
            }
        });
        
        const video = document.getElementById('cameraVideo');
        video.srcObject = stream;
        
        // Verificar linterna en nueva c√°mara
        video.addEventListener('loadedmetadata', async () => {
            await verificarLinterna();
        }, { once: true });
    }
}

// ============================================================================
// DETENER C√ÅMARA
// ============================================================================
function detenerCamara() {
    // Apagar linterna primero
    if (torchEnabled && currentVideoTrack) {
        toggleLinterna(false);
    }
    
    // Detener stream
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    
    currentVideoTrack = null;
}

// ============================================================================
// INICIALIZACI√ìN
// ============================================================================
window.addEventListener('load', async () => {
    try {
        await capturarMetadata();
        await iniciarCamara();
        iniciarReconocimientoVoz();
    } catch (error) {
        console.error('Error inicial:', error);
    }
});

// ============================================================================
// EVENTOS BOTONES
// ============================================================================
document.getElementById('btnCapture').addEventListener('click', function() {
    if (this.classList.contains('confirm')) {
        procesarHoja();
    } else {
        capturarFoto();
    }
});

document.getElementById('btnSwitchCam').addEventListener('click', cambiarCamara);

document.getElementById('btnVoiceToggle').addEventListener('click', toggleVoz);

// ============================================================================
// CAPTURA CON VALIDACI√ìN DE CALIDAD
// ============================================================================
function capturarFoto() {
    if (!gpsObtenido) {
        document.getElementById('gpsAlert').classList.add('active');
        return;
    }

    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('photoCanvas');
    const ctx = canvas.getContext('2d');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    if (canvas.width < 640 || canvas.height < 480) {
        alert('‚ö†Ô∏è Resoluci√≥n muy baja. Intenta con otra c√°mara.');
        return;
    }
    
    ctx.drawImage(video, 0, 0);

    let quality = 0.92;
    if (canvas.width < 1280) {
        quality = 0.95;
    }

    canvas.toBlob((blob) => {
        photoBlob = blob;
        
        const sizeMB = blob.size / 1024 / 1024;
        console.log('üì∏ Foto:', canvas.width + 'x' + canvas.height, sizeMB.toFixed(2) + 'MB');
        
        if (sizeMB < 0.3) {
            if (!confirm('‚ö†Ô∏è Calidad baja (' + sizeMB.toFixed(2) + 'MB). ¬øContinuar?\n\nRecomendaci√≥n: mejor iluminaci√≥n')) {
                return;
            }
        }
        
        const url = URL.createObjectURL(blob);
        document.getElementById('photoImage').src = url;
        
        document.getElementById('cameraView').style.display = 'none';
        document.getElementById('photoPreview').style.display = 'block';
        
        const btn = document.getElementById('btnCapture');
        btn.classList.add('confirm');
        btn.textContent = '‚úÖ Confirmar';
    }, 'image/jpeg', quality);
}

// ============================================================================
// PROCESAMIENTO
// ============================================================================
async function procesarHoja() {
    try {
        document.getElementById('loadingOverlay').classList.add('active');
        
        const formData = new FormData();
        formData.append('file', photoBlob, 'hoja.jpg');
        formData.append('metadata_captura', JSON.stringify(metadataCaptura));
        formData.append('image_hash', await generarDeviceFingerprint());
        
        const response = await fetch('/api/procesar-hoja-completa', {
            method: 'POST',
            body: formData
        });
        
        const resultado = await response.json();
        
        // SI HAY ERROR
        if (!resultado.success || resultado.error) {
            mostrarError(resultado.error || {
                titulo: "Error",
                mensaje: resultado.detail || "Ocurri√≥ un error desconocido",
                icono: "‚ö†Ô∏è"
            });
            return;
        }
        
        // SI ES EXITOSO
        mostrarResultado(resultado);
        
    } catch (error) {
        document.getElementById('loadingOverlay').classList.remove('active');
        console.error('Error en procesarHoja:', error);
        
        mostrarError({
            titulo: "Error de Conexi√≥n",
            mensaje: "No se pudo conectar con el servidor. Verifica tu conexi√≥n a internet.",
            icono: "üì°"
        });
    }
}

// ============================================================================
// AGREGAR ESTAS FUNCIONES NUEVAS AL MISMO <script>
// ============================================================================

function mostrarError(error) {
    document.getElementById('loadingOverlay').classList.remove('active');
    
    // Verificar si ya existe modal de error
    const existingModal = document.querySelector('.error-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Crear HTML del modal
    const errorHTML = `
        <div class="error-modal" style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        ">
            <div class="error-content" style="
                background: white;
                border-radius: 16px;
                padding: 32px;
                max-width: 400px;
                width: 100%;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            ">
                <div class="error-icon" style="
                    font-size: 64px;
                    margin-bottom: 16px;
                ">${error.icono || '‚ö†Ô∏è'}</div>
                
                <h2 style="
                    color: #1e293b;
                    margin-bottom: 12px;
                    font-size: 1.5rem;
                ">${error.titulo || 'Error'}</h2>
                
                <p style="
                    color: #64748b;
                    margin-bottom: 24px;
                    line-height: 1.5;
                ">${error.mensaje || 'Ocurri√≥ un error inesperado'}</p>
                
                ${error.detalles_tecnicos ? `
                    <details style="
                        text-align: left;
                        margin-bottom: 24px;
                        background: #f1f5f9;
                        padding: 12px;
                        border-radius: 8px;
                    ">
                        <summary style="cursor: pointer; font-weight: 600;">Detalles t√©cnicos</summary>
                        <pre style="
                            font-size: 0.75rem;
                            margin-top: 8px;
                            overflow-x: auto;
                        ">${error.detalles_tecnicos}</pre>
                    </details>
                ` : ''}
                
                <button onclick="cerrarError()" style="
                    width: 100%;
                    padding: 14px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 1rem;
                ">Entendido</button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', errorHTML);
}

function cerrarError() {
    const modal = document.querySelector('.error-modal');
    if (modal) {
        modal.remove();
    }
}

// ============================================================================
// MOSTRAR RESULTADO
// ============================================================================
function mostrarResultado(data) {
    document.getElementById('loadingOverlay').classList.remove('active');
    
    const modal = document.getElementById('resultadoModal');
    const estadoVisual = document.getElementById('estadoVisual');
    const iconoEstado = document.getElementById('iconoEstado');
    const mensajeEstado = document.getElementById('mensajeEstado');
    
    // DETERMINAR ESTADO
    if (data.calificacion) {
        // CON NOTA
        iconoEstado.textContent = '‚úÖ';
        mensajeEstado.textContent = '¬°Hoja calificada exitosamente!';
        estadoVisual.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        
        document.getElementById('resultadoNota').textContent = data.calificacion.nota.toFixed(2);
        document.getElementById('resultadoCorrectas').textContent = `${data.calificacion.correctas} / 100`;
        document.getElementById('seccionNota').style.display = 'flex';
        
    } else {
        // SIN NOTA (pendiente gabarito)
        iconoEstado.textContent = '‚è≥';
        mensajeEstado.textContent = 'Hoja procesada - Pendiente de calificaci√≥n';
        estadoVisual.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
        
        document.getElementById('resultadoNota').textContent = 'Pendiente';
        document.getElementById('resultadoCorrectas').textContent = '100 respuestas detectadas';
        document.getElementById('seccionNota').style.display = 'flex';
    }
    
    // POSTULANTE
    if (data.postulante) {
        document.getElementById('resultadoNombre').textContent = data.postulante.nombres;
        document.getElementById('resultadoDni').textContent = data.postulante.dni;
        document.getElementById('resultadoPrograma').textContent = data.postulante.programa || 'No especificado';
    }
    
    // DETALLES T√âCNICOS
    if (data.codigo_hoja) {
        document.getElementById('resultadoCodigoHoja').textContent = data.codigo_hoja;
    }
    
    if (data.procesamiento) {
        document.getElementById('resultadoApi').textContent = data.procesamiento.api || 'OpenAI';
        document.getElementById('resultadoTiempo').textContent = data.procesamiento.tiempo || '-';
    }
    
    if (data.respuestas_detectadas !== undefined) {
        document.getElementById('resultadoRespDetectadas').textContent = data.respuestas_detectadas + ' / 100';
    }
    
    // MOSTRAR MODAL
    modal.classList.add('active');
}

function cerrarResultado() {
    document.getElementById('resultadoModal').classList.remove('active');
}

function verDetalles() {
    // TODO: Implementar vista detallada de respuestas
    alert('üìä Vista de detalles en desarrollo');
}

function siguienteHoja() {
    document.getElementById('resultadoModal').classList.remove('active');
    document.getElementById('photoPreview').style.display = 'none';
    document.getElementById('cameraView').style.display = 'block';
    
    const btn = document.getElementById('btnCapture');
    btn.classList.remove('confirm');
    btn.textContent = 'üì∏ Capturar';
    
    photoBlob = null;
}
</script>
{% endblock %}