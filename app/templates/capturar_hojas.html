{% extends "base.html" %}

{% block title %}Capturar Hojas{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: #000;
        color: #f8fafc;
        overflow: hidden;
        height: 100vh;
    }

    /* HEADER M√çNIMO */
    .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 12px;
        background: rgba(15, 23, 42, 0.95);
        border-bottom: 1px solid #334155;
        height: 44px;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .btn-volver {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: transparent;
        color: #f8fafc;
        border: 1px solid #334155;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.8125rem;
        font-weight: 600;
    }

    .header-title {
        font-size: 0.9375rem;
        font-weight: 700;
    }

    .header-right {
        display: flex;
        gap: 8px;
    }

    .header-link {
        padding: 4px 10px;
        color: #60a5fa;
        text-decoration: none;
        font-size: 0.8125rem;
        font-weight: 600;
        border-radius: 6px;
    }

    /* C√ÅMARA FULLSCREEN - CORREGIDO */
    .camera-fullscreen {
        position: relative;
        height: calc(100vh - 44px - 60px); /* Header + Botones */
        background: #000;
        overflow: hidden;
    }

    .camera-fullscreen #cameraView,
    .camera-fullscreen #photoPreview {
        height: 100%;
        width: 100%;
    }

    #cameraView {
        display: block;
    }

    #cameraVideo {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
    }

    #photoPreview {
        display: none;
        width: 100%;
        height: 100%;
    }

    #photoImage {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
    }

    /* MARCO AZUL */
    .camera-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 5;
    }

    .camera-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        height: 95%;
        border: 2px solid #3b82f6;
        border-radius: 8px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4);
    }

    /* STATUS MINI */
    .status-mini {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 8px;
        z-index: 10;
    }

    .status-badge {
        padding: 4px 10px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 12px;
        font-size: 0.6875rem;
        backdrop-filter: blur(10px);
        color: #94a3b8;
    }

    .status-badge.ok {
        color: #22c55e;
    }

    .status-badge.error {
        color: #ef4444;
    }

    /* BARRA DE BOTONES FIJA */
    .bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: rgba(15, 23, 42, 0.98);
        border-top: 1px solid #334155;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        padding: 0 12px;
        z-index: 100;
        backdrop-filter: blur(10px);
    }

    .btn-bottom {
        flex: 1;
        max-width: 150px;
        padding: 10px 12px;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.2s;
        font-size: 0.8125rem;
    }

    .btn-switch-cam {
        background: rgba(71, 85, 105, 0.9);
        color: white;
    }

    .btn-capture-main {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
    }

    .btn-capture-main.confirm {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }

    .btn-voice-toggle {
        background: rgba(71, 85, 105, 0.9);
        color: white;
    }

    .btn-voice-toggle.active {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }

    /* LOADING */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 200;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(37, 99, 235, 0.3);
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ALERTA GPS */
    .gps-alert {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(239, 68, 68, 0.95);
        color: white;
        padding: 24px;
        border-radius: 12px;
        text-align: center;
        z-index: 150;
        display: none;
        max-width: 400px;
        backdrop-filter: blur(10px);
    }

    .gps-alert.active {
        display: block;
    }

    /* RESULTADOS MODAL */
    .resultado-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 300;
        padding: 20px;
        overflow-y: auto;
    }

    .resultado-modal.active {
        display: flex;
    }

    .resultado-content {
        background: #1e293b;
        border-radius: 16px;
        padding: 24px;
        max-width: 500px;
        width: 100%;
        max-height: 85vh;
        overflow-y: auto;
    }

    .nota-destacada {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 20px;
    }

    .nota-destacada .value {
        font-size: 2.5rem;
        font-weight: 700;
    }

    .resultado-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }

    .resultado-item {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 8px;
    }

    .resultado-item dt {
        font-size: 0.6875rem;
        color: #94a3b8;
        margin-bottom: 4px;
    }

    .resultado-item dd {
        font-size: 0.9375rem;
        color: #f8fafc;
        font-weight: 600;
        margin: 0;
    }

    .btn-siguiente {
        width: 100%;
        padding: 12px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<!-- HEADER -->
<div class="header-bar">
    <div class="header-left">
        <a href="/" class="btn-volver">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Volver
        </a>
        <span class="header-title">üì∏ Capturar Hojas</span>
    </div>
    <div class="header-right">
        <a href="/demo" class="header-link">Demo</a>
        <a href="/resultados" class="header-link">Resultados</a>
    </div>
</div>

<!-- C√ÅMARA FULLSCREEN -->
<div class="camera-fullscreen">
    <!-- Status mini -->
    <div class="status-mini">
        <div class="status-badge" id="statusGPS">üìç Obteniendo...</div>
    </div>

    <!-- Video -->
    <div id="cameraView">
        <video id="cameraVideo" autoplay playsinline></video>
        <div class="camera-overlay">
            <div class="camera-frame"></div>
        </div>
    </div>

    <!-- Preview -->
    <div id="photoPreview">
        <img id="photoImage" alt="Foto capturada">
    </div>

    <!-- Canvas oculto -->
    <canvas id="photoCanvas" style="display: none;"></canvas>

    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p style="color: white; font-size: 1rem; margin-top: 16px;">Procesando con Claude AI...</p>
        <p style="color: #94a3b8; font-size: 0.8125rem; margin-top: 8px;">Extrayendo c√≥digos y respuestas</p>
    </div>

    <!-- Alerta GPS -->
    <div class="gps-alert" id="gpsAlert">
        <h3 style="margin-bottom: 12px;">‚ö†Ô∏è GPS Requerido</h3>
        <p style="margin-bottom: 16px;">Debes compartir tu ubicaci√≥n para capturar hojas. Es un requisito de seguridad del proceso de admisi√≥n.</p>
        <button onclick="solicitarGPS()" style="padding: 10px 20px; background: white; color: #ef4444; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
            Permitir Ubicaci√≥n
        </button>
    </div>
</div>

<!-- BARRA DE BOTONES FIJA -->
<div class="bottom-bar">
    <button type="button" class="btn-bottom btn-switch-cam" id="btnSwitchCam">
        üîÑ Cambiar
    </button>
    <button type="button" class="btn-bottom btn-capture-main" id="btnCapture">
        üì∏ Capturar
    </button>
    <button type="button" class="btn-bottom btn-voice-toggle" id="btnVoiceToggle">
        üé§ Usar Voz
    </button>
</div>

<!-- MODAL DE RESULTADOS -->
<div class="resultado-modal" id="resultadoModal">
    <div class="resultado-content">
        <h3 style="margin-bottom: 16px;">‚úÖ Hoja Procesada</h3>
        <div class="nota-destacada">
            <div style="font-size: 0.8125rem; margin-bottom: 6px;">Nota Final</div>
            <div class="value" id="resultadoNota">-</div>
        </div>
        <div class="resultado-grid">
            <div class="resultado-item"><dt>Postulante</dt><dd id="resultadoNombre">-</dd></div>
            <div class="resultado-item"><dt>DNI</dt><dd id="resultadoDni">-</dd></div>
            <div class="resultado-item"><dt>Programa</dt><dd id="resultadoPrograma">-</dd></div>
            <div class="resultado-item"><dt>Correctas</dt><dd id="resultadoCorrectas">-</dd></div>
            <div class="resultado-item"><dt>C√≥digo Hoja</dt><dd id="resultadoCodigoHoja">-</dd></div>
            <div class="resultado-item"><dt>Tiempo</dt><dd id="resultadoTiempo">-</dd></div>
        </div>
        <button type="button" class="btn-siguiente" onclick="siguienteHoja()">
            Procesar Siguiente Hoja ‚Üí
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let stream;
let recognition;
let metadataCaptura = {};
let vozActiva = false;
let photoBlob = null;
let gpsObtenido = false;

// ============================================================================
// DETECCI√ìN DE CALIDAD DEL DISPOSITIVO
// ============================================================================
function detectarCalidadDispositivo() {
    const screenWidth = screen.width;
    const screenHeight = screen.height;
    const pixelRatio = window.devicePixelRatio || 1;
    
    const score = (screenWidth * screenHeight * pixelRatio) / 1000000;
    
    if (score > 5) {
        return 'high';
    } else if (score > 2) {
        return 'medium';
    } else {
        return 'low';
    }
}

// ============================================================================
// CAPTURA DE METADATA CON GPS OBLIGATORIO
// ============================================================================
async function capturarMetadata() {
    metadataCaptura = {
        timestamp: new Date().toISOString(),
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        user_agent: navigator.userAgent,
        device_fingerprint: await generarDeviceFingerprint(),
        screen: { width: screen.width, height: screen.height },
        device_quality: detectarCalidadDispositivo()
    };

    await solicitarGPS();
}

async function solicitarGPS() {
    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        });

        metadataCaptura.gps = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy
        };

        document.getElementById('statusGPS').className = 'status-badge ok';
        document.getElementById('statusGPS').textContent = 'üìç GPS ‚úì';
        document.getElementById('gpsAlert').classList.remove('active');
        gpsObtenido = true;
    } catch (error) {
        document.getElementById('statusGPS').className = 'status-badge error';
        document.getElementById('statusGPS').textContent = 'üìç GPS ‚úó';
        document.getElementById('gpsAlert').classList.add('active');
        gpsObtenido = false;
        throw new Error('GPS requerido');
    }
}

async function generarDeviceFingerprint() {
    const data = navigator.userAgent + screen.width + screen.height;
    const msgBuffer = new TextEncoder().encode(data);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 32);
}

// ============================================================================
// RECONOCIMIENTO DE VOZ
// ============================================================================
function iniciarReconocimientoVoz() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        document.getElementById('btnVoiceToggle').disabled = true;
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.continuous = true;

    recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase();
        if (transcript.includes('captur') || transcript.includes('foto')) {
            capturarFoto();
        }
    };

    recognition.onerror = (e) => {
        if (e.error === 'no-speech' && vozActiva) {
            recognition.stop();
            setTimeout(() => { if (vozActiva) recognition.start(); }, 1000);
        }
    };

    recognition.onend = () => {
        if (vozActiva) recognition.start();
    };
}

function toggleVoz() {
    vozActiva = !vozActiva;
    const btn = document.getElementById('btnVoiceToggle');
    
    if (vozActiva) {
        btn.classList.add('active');
        btn.textContent = 'üé§ Activo';
        recognition.start();
    } else {
        btn.classList.remove('active');
        btn.textContent = 'üé§ Usar Voz';
        recognition.stop();
    }
}

// ============================================================================
// INICIALIZACI√ìN
// ============================================================================
window.addEventListener('load', async () => {
    try {
        await capturarMetadata();
        await iniciarCamara();
        iniciarReconocimientoVoz();
    } catch (error) {
        console.error('Error inicial:', error);
    }
});

// ============================================================================
// C√ÅMARA CON ADAPTACI√ìN SEG√öN DISPOSITIVO
// ============================================================================
async function iniciarCamara() {
    try {
        const calidadDispositivo = detectarCalidadDispositivo();
        
        let videoConstraints;
        
        switch(calidadDispositivo) {
            case 'high':
                videoConstraints = {
                    width: { ideal: 1920, min: 1280 },
                    height: { ideal: 1440, min: 720 },
                    facingMode: 'environment'
                };
                break;
            case 'medium':
                videoConstraints = {
                    width: { ideal: 1280, min: 640 },
                    height: { ideal: 960, min: 480 },
                    facingMode: 'environment'
                };
                break;
            case 'low':
                videoConstraints = {
                    width: { ideal: 1280, min: 640 },
                    height: { ideal: 960, min: 480 },
                    facingMode: 'environment'
                };
                break;
        }
        
        stream = await navigator.mediaDevices.getUserMedia({
            video: videoConstraints,
            audio: false
        });
        
        document.getElementById('cameraVideo').srcObject = stream;
        
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        console.log('üì∑ C√°mara:', settings.width + 'x' + settings.height);
        console.log('üì± Calidad:', calidadDispositivo);
        
        if (settings.width < 1280 || settings.height < 720) {
            console.warn('‚ö†Ô∏è Resoluci√≥n baja detectada');
        }
        
    } catch (error) {
        alert('No se pudo acceder a la c√°mara');
    }
}

// ============================================================================
// EVENTOS BOTONES
// ============================================================================
document.getElementById('btnCapture').addEventListener('click', function() {
    if (this.classList.contains('confirm')) {
        procesarHoja();
    } else {
        capturarFoto();
    }
});

document.getElementById('btnSwitchCam').addEventListener('click', async () => {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        const currentFacing = stream.getVideoTracks()[0].getSettings().facingMode;
        const newFacing = currentFacing === 'environment' ? 'user' : 'environment';
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: newFacing }
        });
        document.getElementById('cameraVideo').srcObject = stream;
    }
});

document.getElementById('btnVoiceToggle').addEventListener('click', toggleVoz);

// ============================================================================
// CAPTURA CON VALIDACI√ìN DE CALIDAD
// ============================================================================
function capturarFoto() {
    if (!gpsObtenido) {
        document.getElementById('gpsAlert').classList.add('active');
        return;
    }

    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('photoCanvas');
    const ctx = canvas.getContext('2d');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    if (canvas.width < 640 || canvas.height < 480) {
        alert('‚ö†Ô∏è Resoluci√≥n muy baja. Intenta con otra c√°mara.');
        return;
    }
    
    ctx.drawImage(video, 0, 0);

    let quality = 0.92;
    if (canvas.width < 1280) {
        quality = 0.95;
    }

    canvas.toBlob((blob) => {
        photoBlob = blob;
        
        const sizeMB = blob.size / 1024 / 1024;
        console.log('üì∏ Foto:', canvas.width + 'x' + canvas.height, sizeMB.toFixed(2) + 'MB');
        
        if (sizeMB < 0.3) {
            if (!confirm('‚ö†Ô∏è Calidad baja (' + sizeMB.toFixed(2) + 'MB). ¬øContinuar?\n\nRecomendaci√≥n: mejor iluminaci√≥n')) {
                return;
            }
        }
        
        const url = URL.createObjectURL(blob);
        document.getElementById('photoImage').src = url;
        
        document.getElementById('cameraView').style.display = 'none';
        document.getElementById('photoPreview').style.display = 'block';
        
        const btn = document.getElementById('btnCapture');
        btn.classList.add('confirm');
        btn.textContent = '‚úÖ Confirmar';
    }, 'image/jpeg', quality);
}

// ============================================================================
// PROCESAMIENTO
// ============================================================================
async function procesarHoja() {
    try {
        document.getElementById('loadingOverlay').classList.add('active');
        
        const formData = new FormData();
        formData.append('file', photoBlob, 'hoja.jpg');
        formData.append('metadata_captura', JSON.stringify(metadataCaptura));
        formData.append('image_hash', await generarDeviceFingerprint());
        
        const response = await fetch('/api/procesar-hoja-completa', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Error al procesar');
        }
        
        const resultado = await response.json();
        mostrarResultado(resultado);
    } catch (error) {
        alert('Error: ' + error.message);
        document.getElementById('loadingOverlay').classList.remove('active');
    }
}

function mostrarResultado(data) {
    document.getElementById('loadingOverlay').classList.remove('active');
    
    if (data.postulante) {
        document.getElementById('resultadoNombre').textContent = data.postulante.nombres;
        document.getElementById('resultadoDni').textContent = data.postulante.dni;
        document.getElementById('resultadoPrograma').textContent = data.postulante.programa || '-';
    }
    
    if (data.calificacion) {
        document.getElementById('resultadoNota').textContent = data.calificacion.nota.toFixed(2);
        document.getElementById('resultadoCorrectas').textContent = `${data.calificacion.correctas} / 100`;
    }
    
    if (data.codigo_hoja) {
        document.getElementById('resultadoCodigoHoja').textContent = data.codigo_hoja;
    }
    
    if (data.procesamiento) {
        document.getElementById('resultadoTiempo').textContent = data.procesamiento.tiempo;
    }
    
    document.getElementById('resultadoModal').classList.add('active');
}

function siguienteHoja() {
    document.getElementById('resultadoModal').classList.remove('active');
    document.getElementById('photoPreview').style.display = 'none';
    document.getElementById('cameraView').style.display = 'block';
    
    const btn = document.getElementById('btnCapture');
    btn.classList.remove('confirm');
    btn.textContent = 'üì∏ Capturar';
    
    photoBlob = null;
}
</script>
{% endblock %}